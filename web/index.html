<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ren - WebGPU 3D Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-family: system-ui, sans-serif;
            font-size: 18px;
        }
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #f44;
            font-family: system-ui, sans-serif;
            font-size: 16px;
            max-width: 600px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            display: none;
        }
        #stats {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            font-family: monospace;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 4px;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            margin-top: 100px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        #controls button, #controls label {
            background: rgba(60, 120, 200, 0.8);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: system-ui, sans-serif;
            font-size: 13px;
        }
        #controls button:hover, #controls label:hover {
            background: rgba(80, 140, 220, 0.9);
        }
        #controls input[type="file"] {
            display: none;
        }

        /* Right panel with tabs */
        #panel {
            position: absolute;
            top: 10px;
            right: 10px;
            bottom: 10px;
            width: 280px;
            background: rgba(20, 20, 25, 0.95);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            font-family: system-ui, sans-serif;
            font-size: 13px;
            color: #fff;
            overflow: hidden;
        }
        .tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }
        .tab {
            flex: 1;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #888;
            font-size: 11px;
            font-family: system-ui, sans-serif;
            transition: all 0.2s;
        }
        .tab:hover {
            color: #aaa;
            background: rgba(255, 255, 255, 0.05);
        }
        .tab.active {
            color: #8cf;
            background: rgba(100, 150, 255, 0.1);
            border-bottom: 2px solid #8cf;
        }
        .tab-content {
            display: none;
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }
        .tab-content.active {
            display: block;
        }
        .tab-content::-webkit-scrollbar {
            width: 6px;
        }
        .tab-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }
        .tab-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }
        .tab-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .section {
            margin-bottom: 15px;
        }
        .section h3 {
            font-size: 12px;
            color: #8cf;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .section label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }
        .section input[type="range"] {
            flex: 1;
            max-width: 100px;
        }
        .section input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        .section select {
            flex: 1;
            max-width: 100px;
            background: #333;
            color: #fff;
            border: 1px solid #444;
            padding: 4px;
            border-radius: 3px;
        }
        .section input[type="color"] {
            width: 50px;
            height: 24px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .value {
            width: 40px;
            text-align: right;
            color: #8f8;
            font-size: 12px;
        }
        .divider {
            border: none;
            border-top: 1px solid #333;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="loading">Loading Ren Engine...</div>
    <div id="error"></div>
    <div id="stats"></div>
    <div id="controls">
        <label for="model-input">Load Model</label>
        <input type="file" id="model-input" accept=".glb,.gltf,.obj">
        <button id="clear-btn">Clear Models</button>
        <button id="demo-btn">Add Demo</button>
    </div>

    <div id="panel">
        <div class="tabs">
            <button class="tab active" data-tab="lighting">Lighting</button>
            <button class="tab" data-tab="effects">Effects</button>
            <button class="tab" data-tab="aa">AA</button>
            <button class="tab" data-tab="scene">Scene</button>
        </div>

        <!-- Lighting Tab -->
        <div class="tab-content active" id="tab-lighting">
            <div class="section">
                <h3>Bloom</h3>
                <label>
                    <input type="checkbox" id="bloom-enabled" checked>
                    Enable
                </label>
                <label>
                    Intensity
                    <input type="range" id="bloom-intensity" min="0" max="2" step="0.1" value="0.8">
                    <span class="value" id="bloom-intensity-val">0.8</span>
                </label>
                <label>
                    Threshold
                    <input type="range" id="bloom-threshold" min="0" max="1" step="0.05" value="0.6">
                    <span class="value" id="bloom-threshold-val">0.6</span>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Tonemapping</h3>
                <label>
                    Exposure
                    <input type="range" id="exposure" min="0.5" max="3" step="0.1" value="1.5">
                    <span class="value" id="exposure-val">1.5</span>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Vignette</h3>
                <label>
                    <input type="checkbox" id="vignette-enabled" checked>
                    Enable
                </label>
                <label>
                    Intensity
                    <input type="range" id="vignette-intensity" min="0" max="1" step="0.05" value="0.3">
                    <span class="value" id="vignette-intensity-val">0.3</span>
                </label>
                <label>
                    Smoothness
                    <input type="range" id="vignette-smoothness" min="0.1" max="1.5" step="0.05" value="0.5">
                    <span class="value" id="vignette-smoothness-val">0.5</span>
                </label>
                <label>
                    Roundness
                    <input type="range" id="vignette-roundness" min="0" max="1" step="0.1" value="1.0">
                    <span class="value" id="vignette-roundness-val">1.0</span>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Color Correction</h3>
                <label>
                    <input type="checkbox" id="cc-enabled">
                    Enable
                </label>
                <label>
                    Brightness
                    <input type="range" id="cc-brightness" min="-1" max="1" step="0.05" value="0">
                    <span class="value" id="cc-brightness-val">0.00</span>
                </label>
                <label>
                    Contrast
                    <input type="range" id="cc-contrast" min="0" max="2" step="0.05" value="1">
                    <span class="value" id="cc-contrast-val">1.00</span>
                </label>
                <label>
                    Saturation
                    <input type="range" id="cc-saturation" min="0" max="2" step="0.05" value="1">
                    <span class="value" id="cc-saturation-val">1.00</span>
                </label>
                <label>
                    Gamma
                    <input type="range" id="cc-gamma" min="0.5" max="2.5" step="0.05" value="1">
                    <span class="value" id="cc-gamma-val">1.00</span>
                </label>
                <label>
                    Temperature
                    <input type="range" id="cc-temperature" min="-1" max="1" step="0.05" value="0">
                    <span class="value" id="cc-temperature-val">0.00</span>
                </label>
                <label>
                    Tint
                    <input type="range" id="cc-tint" min="-1" max="1" step="0.05" value="0">
                    <span class="value" id="cc-tint-val">0.00</span>
                </label>
                <button id="cc-reset" style="margin-top: 5px; padding: 5px 10px; background: #444; border: none; color: #fff; border-radius: 3px; cursor: pointer;">Reset</button>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Hemisphere Light</h3>
                <label>
                    <input type="checkbox" id="hemisphere-enabled">
                    Enable
                </label>
                <label>
                    Sky Color
                    <input type="color" id="hemisphere-sky-color" value="#99bfff">
                </label>
                <label>
                    Ground Color
                    <input type="color" id="hemisphere-ground-color" value="#664d33">
                </label>
                <label>
                    Intensity
                    <input type="range" id="hemisphere-intensity" min="0" max="2" step="0.1" value="1.0">
                    <span class="value" id="hemisphere-intensity-val">1.0</span>
                </label>
            </div>
        </div>

        <!-- Effects Tab -->
        <div class="tab-content" id="tab-effects">
            <div class="section">
                <h3>Depth of Field</h3>
                <label>
                    <input type="checkbox" id="dof-enabled">
                    Enable
                </label>
                <label>
                    Quality
                    <select id="dof-quality">
                        <option value="0">Low</option>
                        <option value="1" selected>Medium</option>
                        <option value="2">High</option>
                    </select>
                </label>
                <label>
                    Focal Dist
                    <input type="range" id="dof-focal-distance" min="1" max="20" step="0.5" value="5">
                    <span class="value" id="dof-focal-distance-val">5.0</span>
                </label>
                <label>
                    Focal Range
                    <input type="range" id="dof-focal-range" min="0.5" max="10" step="0.5" value="2">
                    <span class="value" id="dof-focal-range-val">2.0</span>
                </label>
                <label>
                    Blur
                    <input type="range" id="dof-blur-strength" min="0" max="3" step="0.1" value="1">
                    <span class="value" id="dof-blur-strength-val">1.0</span>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>SSR (Reflections)</h3>
                <label>
                    <input type="checkbox" id="ssr-enabled">
                    Enable
                </label>
                <label>
                    Quality
                    <select id="ssr-quality">
                        <option value="0">Low</option>
                        <option value="1" selected>Medium</option>
                        <option value="2">High</option>
                        <option value="3">Ultra</option>
                    </select>
                </label>
                <label>
                    Max Dist
                    <input type="range" id="ssr-max-distance" min="5" max="50" step="1" value="20">
                    <span class="value" id="ssr-max-distance-val">20</span>
                </label>
                <label>
                    Thickness
                    <input type="range" id="ssr-thickness" min="0.01" max="1" step="0.01" value="0.1">
                    <span class="value" id="ssr-thickness-val">0.10</span>
                </label>
                <label>
                    Intensity
                    <input type="range" id="ssr-intensity" min="0" max="1" step="0.05" value="0.5">
                    <span class="value" id="ssr-intensity-val">0.50</span>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Motion Blur</h3>
                <label>
                    <input type="checkbox" id="motion-blur-enabled">
                    Enable
                </label>
                <label>
                    Quality
                    <select id="motion-blur-quality">
                        <option value="0">Low</option>
                        <option value="1" selected>Medium</option>
                        <option value="2">High</option>
                    </select>
                </label>
                <label>
                    Intensity
                    <input type="range" id="motion-blur-intensity" min="0" max="2" step="0.1" value="1.0">
                    <span class="value" id="motion-blur-intensity-val">1.0</span>
                </label>
                <label>
                    Max Blur
                    <input type="range" id="motion-blur-max" min="4" max="64" step="2" value="32">
                    <span class="value" id="motion-blur-max-val">32</span>
                </label>
                <label>
                    Vel Scale
                    <input type="range" id="motion-blur-velocity" min="0.1" max="3" step="0.1" value="1.0">
                    <span class="value" id="motion-blur-velocity-val">1.0</span>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Outline</h3>
                <label>
                    <input type="checkbox" id="outline-enabled">
                    Enable
                </label>
                <label>
                    Mode
                    <select id="outline-mode">
                        <option value="0">Depth</option>
                        <option value="1">Normal</option>
                        <option value="2" selected>Combined</option>
                    </select>
                </label>
                <label>
                    Thickness
                    <input type="range" id="outline-thickness" min="0.5" max="5" step="0.5" value="1.0">
                    <span class="value" id="outline-thickness-val">1.0</span>
                </label>
                <label>
                    Depth Thr
                    <input type="range" id="outline-depth" min="0.01" max="0.5" step="0.01" value="0.1">
                    <span class="value" id="outline-depth-val">0.10</span>
                </label>
                <label>
                    Normal Thr
                    <input type="range" id="outline-normal" min="0" max="1" step="0.05" value="0.5">
                    <span class="value" id="outline-normal-val">0.50</span>
                </label>
                <label>
                    Color
                    <input type="color" id="outline-color" value="#000000">
                </label>
            </div>
        </div>

        <!-- AA Tab -->
        <div class="tab-content" id="tab-aa">
            <div class="section">
                <h3>Anti-Aliasing</h3>
                <label>
                    Mode
                    <select id="aa-mode">
                        <option value="0">None</option>
                        <option value="1" selected>FXAA</option>
                        <option value="2">SMAA</option>
                        <option value="3">TAA</option>
                    </select>
                </label>
            </div>
            <div id="fxaa-options" class="section">
                <h3>FXAA Options</h3>
                <label>
                    Quality
                    <select id="fxaa-quality">
                        <option value="0">Low</option>
                        <option value="1">Medium</option>
                        <option value="2" selected>High</option>
                    </select>
                </label>
            </div>
            <div id="smaa-options" class="section" style="display: none;">
                <h3>SMAA Options</h3>
                <label>
                    Quality
                    <select id="smaa-quality">
                        <option value="0">Low</option>
                        <option value="1">Medium</option>
                        <option value="2" selected>High</option>
                        <option value="3">Ultra</option>
                    </select>
                </label>
            </div>
            <div id="taa-options" class="section" style="display: none;">
                <h3>TAA Options</h3>
                <label>
                    Blend
                    <input type="range" id="taa-blend" min="0.5" max="0.98" step="0.02" value="0.9">
                    <span class="value" id="taa-blend-val">0.9</span>
                </label>
                <label>
                    Sharpness
                    <input type="range" id="taa-sharpness" min="0" max="1" step="0.1" value="0.2">
                    <span class="value" id="taa-sharpness-val">0.2</span>
                </label>
            </div>
        </div>

        <!-- Scene Tab -->
        <div class="tab-content" id="tab-scene">
            <div class="section">
                <h3>SSAO</h3>
                <label>
                    <input type="checkbox" id="ssao-enabled" checked>
                    Enable
                </label>
                <label>
                    Quality
                    <select id="ssao-quality">
                        <option value="0">Low</option>
                        <option value="1" selected>Medium</option>
                        <option value="2">High</option>
                        <option value="3">Ultra</option>
                    </select>
                </label>
                <label>
                    Radius
                    <input type="range" id="ssao-radius" min="0.1" max="2" step="0.1" value="0.5">
                    <span class="value" id="ssao-radius-val">0.5</span>
                </label>
                <label>
                    Intensity
                    <input type="range" id="ssao-intensity" min="0" max="3" step="0.1" value="1.0">
                    <span class="value" id="ssao-intensity-val">1.0</span>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Helpers</h3>
                <label>
                    <input type="checkbox" id="show-grid" checked>
                    Show Grid
                </label>
                <label>
                    <input type="checkbox" id="show-axes" checked>
                    Show Axes
                </label>
            </div>
        </div>
    </div>

    <script type="module">
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        async function init() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const statsEl = document.getElementById('stats');
            const canvas = document.getElementById('canvas');

            try {
                // Check for WebGPU support
                if (!navigator.gpu) {
                    throw new Error(
                        'WebGPU is not supported in your browser.\n\n' +
                        'Try using Chrome 113+, Edge 113+, or Firefox Nightly with dom.webgpu.enabled set to true.'
                    );
                }

                // Request adapter
                const adapter = await navigator.gpu.requestAdapter();
                if (!adapter) {
                    throw new Error('Failed to get WebGPU adapter. Your GPU may not be supported.');
                }

                // Load WASM module
                const { default: init, RenApp } = await import('./pkg/ren.js');
                await init();

                loadingEl.style.display = 'none';

                // Create and run the app
                const app = await RenApp.new('canvas');

                let lastTime = performance.now();
                let frameCount = 0;
                let fps = 0;

                // Animation loop
                function frame() {
                    app.frame();
                    frameCount++;

                    const now = performance.now();
                    if (now - lastTime >= 1000) {
                        fps = frameCount;
                        frameCount = 0;
                        lastTime = now;

                        const stats = app.stats();
                        statsEl.innerHTML = `
                            FPS: ${fps}<br>
                            Draw Calls: ${stats.draw_calls}<br>
                            Triangles: ${stats.triangles}<br>
                            Frame: ${stats.frame}
                        `;
                    }

                    requestAnimationFrame(frame);
                }
                requestAnimationFrame(frame);

                // Handle resize
                window.addEventListener('resize', () => {
                    app.resize(window.innerWidth, window.innerHeight);
                });

                // Mouse controls
                let isDragging = false;
                let isPanning = false;
                let lastMouseX = 0;
                let lastMouseY = 0;

                canvas.addEventListener('mousedown', (e) => {
                    if (e.button === 0) {
                        if (e.shiftKey) {
                            isPanning = true;
                        } else {
                            isDragging = true;
                        }
                    } else if (e.button === 2) {
                        isPanning = true;
                    }
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;
                    e.preventDefault();
                });

                window.addEventListener('mouseup', () => {
                    isDragging = false;
                    isPanning = false;
                });

                window.addEventListener('mousemove', (e) => {
                    const deltaX = e.clientX - lastMouseX;
                    const deltaY = e.clientY - lastMouseY;
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;

                    if (isDragging) {
                        app.on_mouse_drag(deltaX, deltaY);
                    } else if (isPanning) {
                        app.on_mouse_pan(deltaX, deltaY);
                    }
                });

                canvas.addEventListener('wheel', (e) => {
                    app.on_mouse_wheel(e.deltaY);
                    e.preventDefault();
                }, { passive: false });

                canvas.addEventListener('contextmenu', (e) => e.preventDefault());

                // Model loading
                const modelInput = document.getElementById('model-input');
                const clearBtn = document.getElementById('clear-btn');

                modelInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        const ext = file.name.split('.').pop().toLowerCase();

                        if (ext === 'glb' || ext === 'gltf') {
                            const arrayBuffer = await file.arrayBuffer();
                            const data = new Uint8Array(arrayBuffer);
                            const count = app.load_gltf(data);
                            console.log(`Loaded ${count} mesh(es) from ${file.name}`);
                        } else if (ext === 'obj') {
                            const text = await file.text();
                            const count = app.load_obj(text);
                            console.log(`Loaded ${count} mesh(es) from ${file.name}`);
                        }
                    } catch (err) {
                        console.error('Failed to load model:', err);
                        alert('Failed to load model: ' + err);
                    }
                    modelInput.value = '';
                });

                clearBtn.addEventListener('click', () => {
                    app.clear_loaded_meshes();
                    console.log('Cleared loaded models');
                });

                const demoBtn = document.getElementById('demo-btn');
                demoBtn.addEventListener('click', () => {
                    app.add_demo_shapes();
                    console.log('Added demo shapes');
                });

                app.add_demo_shapes();

                // Bloom controls
                document.getElementById('bloom-enabled').addEventListener('change', (e) => {
                    app.set_bloom_enabled(e.target.checked);
                });
                document.getElementById('bloom-intensity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_bloom_intensity(val);
                    document.getElementById('bloom-intensity-val').textContent = val.toFixed(1);
                });
                document.getElementById('bloom-threshold').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_bloom_threshold(val);
                    document.getElementById('bloom-threshold-val').textContent = val.toFixed(2);
                });
                document.getElementById('exposure').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_exposure(val);
                    document.getElementById('exposure-val').textContent = val.toFixed(1);
                });

                // AA controls
                const aaMode = document.getElementById('aa-mode');
                function updateAAOptions() {
                    const mode = parseInt(aaMode.value);
                    document.getElementById('fxaa-options').style.display = mode === 1 ? 'block' : 'none';
                    document.getElementById('smaa-options').style.display = mode === 2 ? 'block' : 'none';
                    document.getElementById('taa-options').style.display = mode === 3 ? 'block' : 'none';
                }
                aaMode.addEventListener('change', (e) => {
                    app.set_aa_mode(parseInt(e.target.value));
                    updateAAOptions();
                });
                document.getElementById('fxaa-quality').addEventListener('change', (e) => {
                    app.set_fxaa_quality(parseInt(e.target.value));
                });
                document.getElementById('smaa-quality').addEventListener('change', (e) => {
                    app.set_smaa_quality(parseInt(e.target.value));
                });
                document.getElementById('taa-blend').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_taa_blend_factor(val);
                    document.getElementById('taa-blend-val').textContent = val.toFixed(2);
                });
                document.getElementById('taa-sharpness').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_taa_sharpness(val);
                    document.getElementById('taa-sharpness-val').textContent = val.toFixed(1);
                });

                // Helper controls
                document.getElementById('show-grid').addEventListener('change', (e) => {
                    app.set_grid_visible(e.target.checked);
                });
                document.getElementById('show-axes').addEventListener('change', (e) => {
                    app.set_axes_visible(e.target.checked);
                });

                // SSAO controls
                document.getElementById('ssao-enabled').addEventListener('change', (e) => {
                    app.set_ssao_enabled(e.target.checked);
                });
                document.getElementById('ssao-quality').addEventListener('change', (e) => {
                    app.set_ssao_quality(parseInt(e.target.value));
                });
                document.getElementById('ssao-radius').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_ssao_radius(val);
                    document.getElementById('ssao-radius-val').textContent = val.toFixed(1);
                });
                document.getElementById('ssao-intensity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_ssao_intensity(val);
                    document.getElementById('ssao-intensity-val').textContent = val.toFixed(1);
                });

                // Vignette controls
                document.getElementById('vignette-enabled').addEventListener('change', (e) => {
                    app.set_vignette_enabled(e.target.checked);
                });
                document.getElementById('vignette-intensity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_vignette_intensity(val);
                    document.getElementById('vignette-intensity-val').textContent = val.toFixed(2);
                });
                document.getElementById('vignette-smoothness').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_vignette_smoothness(val);
                    document.getElementById('vignette-smoothness-val').textContent = val.toFixed(2);
                });
                document.getElementById('vignette-roundness').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_vignette_roundness(val);
                    document.getElementById('vignette-roundness-val').textContent = val.toFixed(1);
                });

                // DoF controls
                document.getElementById('dof-enabled').addEventListener('change', (e) => {
                    app.set_dof_enabled(e.target.checked);
                });
                document.getElementById('dof-quality').addEventListener('change', (e) => {
                    app.set_dof_quality(parseInt(e.target.value));
                });
                document.getElementById('dof-focal-distance').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_dof_focal_distance(val);
                    document.getElementById('dof-focal-distance-val').textContent = val.toFixed(1);
                });
                document.getElementById('dof-focal-range').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_dof_focal_range(val);
                    document.getElementById('dof-focal-range-val').textContent = val.toFixed(1);
                });
                document.getElementById('dof-blur-strength').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_dof_blur_strength(val);
                    document.getElementById('dof-blur-strength-val').textContent = val.toFixed(1);
                });

                // SSR controls
                document.getElementById('ssr-enabled').addEventListener('change', (e) => {
                    app.set_ssr_enabled(e.target.checked);
                });
                document.getElementById('ssr-quality').addEventListener('change', (e) => {
                    app.set_ssr_quality(parseInt(e.target.value));
                });
                document.getElementById('ssr-max-distance').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_ssr_max_distance(val);
                    document.getElementById('ssr-max-distance-val').textContent = val.toFixed(0);
                });
                document.getElementById('ssr-thickness').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_ssr_thickness(val);
                    document.getElementById('ssr-thickness-val').textContent = val.toFixed(2);
                });
                document.getElementById('ssr-intensity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_ssr_intensity(val);
                    document.getElementById('ssr-intensity-val').textContent = val.toFixed(2);
                });

                // Motion blur controls
                document.getElementById('motion-blur-enabled').addEventListener('change', (e) => {
                    app.set_motion_blur_enabled(e.target.checked);
                });
                document.getElementById('motion-blur-quality').addEventListener('change', (e) => {
                    app.set_motion_blur_quality(parseInt(e.target.value));
                });
                document.getElementById('motion-blur-intensity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_motion_blur_intensity(val);
                    document.getElementById('motion-blur-intensity-val').textContent = val.toFixed(1);
                });
                document.getElementById('motion-blur-max').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_motion_blur_max(val);
                    document.getElementById('motion-blur-max-val').textContent = val.toFixed(0);
                });
                document.getElementById('motion-blur-velocity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_motion_blur_velocity_scale(val);
                    document.getElementById('motion-blur-velocity-val').textContent = val.toFixed(1);
                });

                // Outline controls
                document.getElementById('outline-enabled').addEventListener('change', (e) => {
                    app.set_outline_enabled(e.target.checked);
                });
                document.getElementById('outline-mode').addEventListener('change', (e) => {
                    app.set_outline_mode(parseInt(e.target.value));
                });
                document.getElementById('outline-thickness').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_outline_thickness(val);
                    document.getElementById('outline-thickness-val').textContent = val.toFixed(1);
                });
                document.getElementById('outline-depth').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_outline_depth_threshold(val);
                    document.getElementById('outline-depth-val').textContent = val.toFixed(2);
                });
                document.getElementById('outline-normal').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_outline_normal_threshold(val);
                    document.getElementById('outline-normal-val').textContent = val.toFixed(2);
                });
                document.getElementById('outline-color').addEventListener('input', (e) => {
                    const hex = e.target.value;
                    const r = parseInt(hex.substr(1, 2), 16) / 255;
                    const g = parseInt(hex.substr(3, 2), 16) / 255;
                    const b = parseInt(hex.substr(5, 2), 16) / 255;
                    app.set_outline_color(r, g, b);
                });

                // Color correction controls
                document.getElementById('cc-enabled').addEventListener('change', (e) => {
                    app.set_color_correction_enabled(e.target.checked);
                });
                document.getElementById('cc-brightness').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_cc_brightness(val);
                    document.getElementById('cc-brightness-val').textContent = val.toFixed(2);
                });
                document.getElementById('cc-contrast').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_cc_contrast(val);
                    document.getElementById('cc-contrast-val').textContent = val.toFixed(2);
                });
                document.getElementById('cc-saturation').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_cc_saturation(val);
                    document.getElementById('cc-saturation-val').textContent = val.toFixed(2);
                });
                document.getElementById('cc-gamma').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_cc_gamma(val);
                    document.getElementById('cc-gamma-val').textContent = val.toFixed(2);
                });
                document.getElementById('cc-temperature').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_cc_temperature(val);
                    document.getElementById('cc-temperature-val').textContent = val.toFixed(2);
                });
                document.getElementById('cc-tint').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_cc_tint(val);
                    document.getElementById('cc-tint-val').textContent = val.toFixed(2);
                });
                document.getElementById('cc-reset').addEventListener('click', () => {
                    app.reset_color_correction();
                    document.getElementById('cc-brightness').value = 0;
                    document.getElementById('cc-brightness-val').textContent = '0.00';
                    document.getElementById('cc-contrast').value = 1;
                    document.getElementById('cc-contrast-val').textContent = '1.00';
                    document.getElementById('cc-saturation').value = 1;
                    document.getElementById('cc-saturation-val').textContent = '1.00';
                    document.getElementById('cc-gamma').value = 1;
                    document.getElementById('cc-gamma-val').textContent = '1.00';
                    document.getElementById('cc-temperature').value = 0;
                    document.getElementById('cc-temperature-val').textContent = '0.00';
                    document.getElementById('cc-tint').value = 0;
                    document.getElementById('cc-tint-val').textContent = '0.00';
                });

                // Hemisphere light controls
                document.getElementById('hemisphere-enabled').addEventListener('change', (e) => {
                    app.set_hemisphere_light_enabled(e.target.checked);
                });
                document.getElementById('hemisphere-sky-color').addEventListener('input', (e) => {
                    const hex = e.target.value;
                    const r = parseInt(hex.substr(1, 2), 16) / 255;
                    const g = parseInt(hex.substr(3, 2), 16) / 255;
                    const b = parseInt(hex.substr(5, 2), 16) / 255;
                    app.set_hemisphere_sky_color(r, g, b);
                });
                document.getElementById('hemisphere-ground-color').addEventListener('input', (e) => {
                    const hex = e.target.value;
                    const r = parseInt(hex.substr(1, 2), 16) / 255;
                    const g = parseInt(hex.substr(3, 2), 16) / 255;
                    const b = parseInt(hex.substr(5, 2), 16) / 255;
                    app.set_hemisphere_ground_color(r, g, b);
                });
                document.getElementById('hemisphere-intensity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_hemisphere_intensity(val);
                    document.getElementById('hemisphere-intensity-val').textContent = val.toFixed(1);
                });

            } catch (err) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = err.message || String(err);
                console.error('Ren Engine initialization failed:', err);
            }
        }

        init();
    </script>
</body>
</html>
