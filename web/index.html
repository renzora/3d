<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ren - WebGPU 3D Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-family: system-ui, sans-serif;
            font-size: 18px;
        }
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #f44;
            font-family: system-ui, sans-serif;
            font-size: 16px;
            max-width: 600px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            display: none;
        }
        #stats {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            font-family: monospace;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 4px;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            margin-top: 100px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        #controls button, #controls label {
            background: rgba(60, 120, 200, 0.8);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: system-ui, sans-serif;
            font-size: 13px;
        }
        #controls button:hover, #controls label:hover {
            background: rgba(80, 140, 220, 0.9);
        }
        #controls input[type="file"] {
            display: none;
        }

        /* Right panel with tabs */
        #panel {
            position: absolute;
            top: 10px;
            right: 10px;
            bottom: 10px;
            width: 280px;
            background: rgba(20, 20, 25, 0.95);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            font-family: system-ui, sans-serif;
            font-size: 13px;
            color: #fff;
            overflow: hidden;
        }
        .tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }
        .tab {
            flex: 1;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #888;
            font-size: 11px;
            font-family: system-ui, sans-serif;
            transition: all 0.2s;
        }
        .tab:hover {
            color: #aaa;
            background: rgba(255, 255, 255, 0.05);
        }
        .tab.active {
            color: #8cf;
            background: rgba(100, 150, 255, 0.1);
            border-bottom: 2px solid #8cf;
        }
        .tab-content {
            display: none;
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }
        .tab-content.active {
            display: block;
        }
        .tab-content::-webkit-scrollbar {
            width: 6px;
        }
        .tab-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }
        .tab-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }
        .tab-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .section {
            margin-bottom: 15px;
        }
        .section h3 {
            font-size: 12px;
            color: #8cf;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .section label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }
        .section input[type="range"] {
            flex: 1;
            max-width: 100px;
        }
        .section input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        .section select {
            flex: 1;
            max-width: 100px;
            background: #333;
            color: #fff;
            border: 1px solid #444;
            padding: 4px;
            border-radius: 3px;
        }
        .section input[type="color"] {
            width: 50px;
            height: 24px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .value {
            width: 40px;
            text-align: right;
            color: #8f8;
            font-size: 12px;
        }
        .divider {
            border: none;
            border-top: 1px solid #333;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="loading">Loading Ren Engine...</div>
    <div id="error"></div>
    <div id="stats"></div>
    <div id="controls">
        <label for="model-input">Load Model</label>
        <input type="file" id="model-input" accept=".glb,.gltf,.obj">
        <button id="clear-btn">Clear Models</button>
        <button id="demo-btn">Add Demo</button>
    </div>

    <div id="panel">
        <div class="tabs">
            <button class="tab active" data-tab="lighting">Lighting</button>
            <button class="tab" data-tab="effects">Effects</button>
            <button class="tab" data-tab="aa">AA</button>
            <button class="tab" data-tab="scene">Scene</button>
        </div>

        <!-- Lighting Tab -->
        <div class="tab-content active" id="tab-lighting">
            <div class="section">
                <h3>Render Mode</h3>
                <label>
                    Mode
                    <select id="render-mode">
                        <option value="0" selected>Lit</option>
                        <option value="1">Unlit</option>
                        <option value="2">Normals</option>
                        <option value="3">Depth</option>
                        <option value="4">Metallic</option>
                        <option value="5">Roughness</option>
                        <option value="6">AO</option>
                        <option value="7">UVs</option>
                        <option value="8">Flat</option>
                        <option value="9">Wireframe</option>
                    </select>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Bloom</h3>
                <label>
                    <input type="checkbox" id="bloom-enabled" checked>
                    Enable
                </label>
                <label>
                    Intensity
                    <input type="range" id="bloom-intensity" min="0" max="2" step="0.1" value="0.8">
                    <span class="value" id="bloom-intensity-val">0.8</span>
                </label>
                <label>
                    Threshold
                    <input type="range" id="bloom-threshold" min="0" max="1" step="0.05" value="0.6">
                    <span class="value" id="bloom-threshold-val">0.6</span>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Tonemapping</h3>
                <label>
                    Exposure
                    <input type="range" id="exposure" min="0.5" max="3" step="0.1" value="1.5">
                    <span class="value" id="exposure-val">1.5</span>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Auto-Exposure</h3>
                <label>
                    <input type="checkbox" id="auto-exposure-enabled">
                    Eye Adaptation
                </label>
                <label>
                    Compensation
                    <input type="range" id="auto-exposure-compensation" min="-2" max="2" step="0.1" value="0">
                    <span class="value" id="auto-exposure-compensation-val">0.0</span>
                </label>
                <label>
                    Speed Up
                    <input type="range" id="auto-exposure-speed-up" min="0.5" max="10" step="0.5" value="3">
                    <span class="value" id="auto-exposure-speed-up-val">3.0</span>
                </label>
                <label>
                    Speed Down
                    <input type="range" id="auto-exposure-speed-down" min="0.5" max="5" step="0.5" value="1">
                    <span class="value" id="auto-exposure-speed-down-val">1.0</span>
                </label>
                <div id="auto-exposure-value" style="font-size: 11px; color: #888; margin-top: 4px;">Current EV: 0.0</div>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>HDR Display</h3>
                <label>
                    <input type="checkbox" id="hdr-output" disabled>
                    Enable 10-bit Output
                </label>
                <div id="hdr-status" style="font-size: 11px; color: #888; margin-top: 4px;">Checking...</div>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Vignette</h3>
                <label>
                    <input type="checkbox" id="vignette-enabled" checked>
                    Enable
                </label>
                <label>
                    Intensity
                    <input type="range" id="vignette-intensity" min="0" max="1" step="0.05" value="0.3">
                    <span class="value" id="vignette-intensity-val">0.3</span>
                </label>
                <label>
                    Smoothness
                    <input type="range" id="vignette-smoothness" min="0.1" max="1.5" step="0.05" value="0.5">
                    <span class="value" id="vignette-smoothness-val">0.5</span>
                </label>
                <label>
                    Roundness
                    <input type="range" id="vignette-roundness" min="0" max="1" step="0.1" value="1.0">
                    <span class="value" id="vignette-roundness-val">1.0</span>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Color Correction</h3>
                <label>
                    <input type="checkbox" id="cc-enabled">
                    Enable
                </label>
                <label>
                    Brightness
                    <input type="range" id="cc-brightness" min="-1" max="1" step="0.05" value="0">
                    <span class="value" id="cc-brightness-val">0.00</span>
                </label>
                <label>
                    Contrast
                    <input type="range" id="cc-contrast" min="0" max="2" step="0.05" value="1">
                    <span class="value" id="cc-contrast-val">1.00</span>
                </label>
                <label>
                    Saturation
                    <input type="range" id="cc-saturation" min="0" max="2" step="0.05" value="1">
                    <span class="value" id="cc-saturation-val">1.00</span>
                </label>
                <label>
                    Gamma
                    <input type="range" id="cc-gamma" min="0.5" max="2.5" step="0.05" value="1">
                    <span class="value" id="cc-gamma-val">1.00</span>
                </label>
                <label>
                    Temperature
                    <input type="range" id="cc-temperature" min="-1" max="1" step="0.05" value="0">
                    <span class="value" id="cc-temperature-val">0.00</span>
                </label>
                <label>
                    Tint
                    <input type="range" id="cc-tint" min="-1" max="1" step="0.05" value="0">
                    <span class="value" id="cc-tint-val">0.00</span>
                </label>
                <button id="cc-reset" style="margin-top: 5px; padding: 5px 10px; background: #444; border: none; color: #fff; border-radius: 3px; cursor: pointer;">Reset</button>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Hemisphere Light</h3>
                <label>
                    <input type="checkbox" id="hemisphere-enabled">
                    Enable
                </label>
                <label>
                    Sky Color
                    <input type="color" id="hemisphere-sky-color" value="#99bfff">
                </label>
                <label>
                    Ground Color
                    <input type="color" id="hemisphere-ground-color" value="#664d33">
                </label>
                <label>
                    Intensity
                    <input type="range" id="hemisphere-intensity" min="0" max="2" step="0.1" value="1.0">
                    <span class="value" id="hemisphere-intensity-val">1.0</span>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Skybox</h3>
                <label>
                    <input type="checkbox" id="skybox-enabled" checked>
                    Enable
                </label>
                <label>
                    Exposure
                    <input type="range" id="skybox-exposure" min="0.1" max="3" step="0.1" value="1.0">
                    <span class="value" id="skybox-exposure-val">1.0</span>
                </label>
                <label>
                    Sky Color
                    <input type="color" id="skybox-sky-color" value="#6496e6">
                </label>
                <label>
                    Horizon Color
                    <input type="color" id="skybox-horizon-color" value="#c8d2dc">
                </label>
                <label>
                    Ground Color
                    <input type="color" id="skybox-ground-color" value="#322d28">
                </label>
                <label style="margin-top: 8px;">
                    HDR Environment
                    <input type="file" id="skybox-hdr-file" accept=".hdr,.exr" style="font-size: 11px; margin-top: 4px;">
                </label>
                <div id="hdr-loading" style="display: none; color: #888; font-size: 11px; margin-top: 4px;">Loading HDR...</div>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Shadows</h3>
                <label>
                    <input type="checkbox" id="shadows-enabled" checked>
                    Enable
                </label>
                <label>
                    Resolution
                    <select id="shadow-resolution">
                        <option value="512">512</option>
                        <option value="1024">1024</option>
                        <option value="2048" selected>2048</option>
                        <option value="4096">4096</option>
                    </select>
                </label>
                <label>
                    PCF Mode
                    <select id="shadow-pcf">
                        <option value="0">None</option>
                        <option value="1">2x2</option>
                        <option value="2" selected>3x3</option>
                        <option value="3">5x5</option>
                        <option value="4">Poisson</option>
                        <option value="5">PCSS (Soft)</option>
                    </select>
                </label>
                <label>
                    Bias
                    <input type="range" id="shadow-bias" min="0.001" max="0.02" step="0.001" value="0.005">
                    <span class="value" id="shadow-bias-val">0.005</span>
                </label>
                <label>
                    Normal Bias
                    <input type="range" id="shadow-normal-bias" min="0" max="0.1" step="0.005" value="0.02">
                    <span class="value" id="shadow-normal-bias-val">0.02</span>
                </label>
                <div id="pcss-controls" style="display: none;">
                    <label>
                        PCSS Light Size
                        <input type="range" id="pcss-light-size" min="0.1" max="5.0" step="0.1" value="0.5">
                        <span class="value" id="pcss-light-size-val">0.5</span>
                    </label>
                    <label>
                        PCSS Max Radius
                        <input type="range" id="pcss-max-radius" min="1" max="30" step="1" value="10">
                        <span class="value" id="pcss-max-radius-val">10</span>
                    </label>
                </div>
                <div class="subsection">
                    <h4>Contact Shadows</h4>
                    <label class="toggle">
                        <input type="checkbox" id="contact-shadows-enabled">
                        Enable Contact Shadows
                    </label>
                    <div id="contact-shadow-controls">
                        <label>
                            Distance
                            <input type="range" id="contact-shadow-distance" min="0.1" max="2.0" step="0.05" value="0.5">
                            <span class="value" id="contact-shadow-distance-val">0.5</span>
                        </label>
                        <label>
                            Thickness
                            <input type="range" id="contact-shadow-thickness" min="0.01" max="0.5" step="0.01" value="0.05">
                            <span class="value" id="contact-shadow-thickness-val">0.05</span>
                        </label>
                        <label>
                            Intensity
                            <input type="range" id="contact-shadow-intensity" min="0" max="1" step="0.05" value="0.5">
                            <span class="value" id="contact-shadow-intensity-val">0.5</span>
                        </label>
                    </div>
                </div>
                <label>
                    Cascades
                    <select id="shadow-cascades">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4" selected>4</option>
                    </select>
                </label>
                <label>
                    Light Type
                    <select id="shadow-light-type">
                        <option value="0" selected>Directional</option>
                        <option value="1">Spot</option>
                        <option value="2">Point</option>
                    </select>
                </label>
                <div id="spot-controls" style="display: none;">
                    <label>
                        Spot Position X
                        <input type="range" id="spot-pos-x" min="-10" max="10" step="0.5" value="0">
                        <span class="value" id="spot-pos-x-val">0</span>
                    </label>
                    <label>
                        Spot Position Y
                        <input type="range" id="spot-pos-y" min="0" max="15" step="0.5" value="5">
                        <span class="value" id="spot-pos-y-val">5</span>
                    </label>
                    <label>
                        Spot Position Z
                        <input type="range" id="spot-pos-z" min="-10" max="10" step="0.5" value="0">
                        <span class="value" id="spot-pos-z-val">0</span>
                    </label>
                    <label>
                        Spot Range
                        <input type="range" id="spot-range" min="5" max="50" step="1" value="15">
                        <span class="value" id="spot-range-val">15</span>
                    </label>
                    <label>
                        Spot Inner Angle
                        <input type="range" id="spot-inner-angle" min="5" max="45" step="1" value="15">
                        <span class="value" id="spot-inner-angle-val">15°</span>
                    </label>
                    <label>
                        Spot Outer Angle
                        <input type="range" id="spot-outer-angle" min="10" max="60" step="1" value="25">
                        <span class="value" id="spot-outer-angle-val">25°</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Effects Tab -->
        <div class="tab-content" id="tab-effects">
            <div class="section">
                <h3>Depth of Field</h3>
                <label>
                    <input type="checkbox" id="dof-enabled">
                    Enable
                </label>
                <label>
                    Quality
                    <select id="dof-quality">
                        <option value="0">Low</option>
                        <option value="1" selected>Medium</option>
                        <option value="2">High</option>
                        <option value="3">Ultra</option>
                    </select>
                </label>
                <label>
                    Focal Dist
                    <input type="range" id="dof-focal-distance" min="1" max="20" step="0.5" value="5">
                    <span class="value" id="dof-focal-distance-val">5.0</span>
                </label>
                <label>
                    Focal Range
                    <input type="range" id="dof-focal-range" min="0.5" max="10" step="0.5" value="2">
                    <span class="value" id="dof-focal-range-val">2.0</span>
                </label>
                <label>
                    Blur
                    <input type="range" id="dof-blur-strength" min="0" max="3" step="0.1" value="1">
                    <span class="value" id="dof-blur-strength-val">1.0</span>
                </label>
                <label>
                    Highlight Boost
                    <input type="range" id="dof-highlight-boost" min="0" max="2" step="0.1" value="0.5">
                    <span class="value" id="dof-highlight-boost-val">0.5</span>
                </label>
                <label>
                    Highlight Threshold
                    <input type="range" id="dof-highlight-threshold" min="0" max="1" step="0.05" value="0.5">
                    <span class="value" id="dof-highlight-threshold-val">0.50</span>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>SSR (Reflections)</h3>
                <label>
                    <input type="checkbox" id="ssr-enabled">
                    Enable
                </label>
                <label>
                    Quality
                    <select id="ssr-quality">
                        <option value="0">Low</option>
                        <option value="1" selected>Medium</option>
                        <option value="2">High</option>
                        <option value="3">Ultra</option>
                    </select>
                </label>
                <label>
                    Max Dist
                    <input type="range" id="ssr-max-distance" min="5" max="50" step="1" value="20">
                    <span class="value" id="ssr-max-distance-val">20</span>
                </label>
                <label>
                    Thickness
                    <input type="range" id="ssr-thickness" min="0.01" max="1" step="0.01" value="0.1">
                    <span class="value" id="ssr-thickness-val">0.10</span>
                </label>
                <label>
                    Intensity
                    <input type="range" id="ssr-intensity" min="0" max="1" step="0.05" value="0.5">
                    <span class="value" id="ssr-intensity-val">0.50</span>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Motion Blur</h3>
                <label>
                    <input type="checkbox" id="motion-blur-enabled">
                    Enable
                </label>
                <label>
                    Quality
                    <select id="motion-blur-quality">
                        <option value="0">Low</option>
                        <option value="1" selected>Medium</option>
                        <option value="2">High</option>
                    </select>
                </label>
                <label>
                    Intensity
                    <input type="range" id="motion-blur-intensity" min="0" max="2" step="0.1" value="1.0">
                    <span class="value" id="motion-blur-intensity-val">1.0</span>
                </label>
                <label>
                    Max Blur
                    <input type="range" id="motion-blur-max" min="4" max="64" step="2" value="32">
                    <span class="value" id="motion-blur-max-val">32</span>
                </label>
                <label>
                    Vel Scale
                    <input type="range" id="motion-blur-velocity" min="0.1" max="3" step="0.1" value="1.0">
                    <span class="value" id="motion-blur-velocity-val">1.0</span>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Outline</h3>
                <label>
                    <input type="checkbox" id="outline-enabled">
                    Enable
                </label>
                <label>
                    Mode
                    <select id="outline-mode">
                        <option value="0">Depth</option>
                        <option value="1">Normal</option>
                        <option value="2" selected>Combined</option>
                    </select>
                </label>
                <label>
                    Thickness
                    <input type="range" id="outline-thickness" min="0.5" max="5" step="0.5" value="1.0">
                    <span class="value" id="outline-thickness-val">1.0</span>
                </label>
                <label>
                    Depth Thr
                    <input type="range" id="outline-depth" min="0.01" max="0.5" step="0.01" value="0.1">
                    <span class="value" id="outline-depth-val">0.10</span>
                </label>
                <label>
                    Normal Thr
                    <input type="range" id="outline-normal" min="0" max="1" step="0.05" value="0.5">
                    <span class="value" id="outline-normal-val">0.50</span>
                </label>
                <label>
                    Color
                    <input type="color" id="outline-color" value="#000000">
                </label>
            </div>
        </div>

        <!-- AA Tab -->
        <div class="tab-content" id="tab-aa">
            <div class="section">
                <h3>Anti-Aliasing</h3>
                <label>
                    Mode
                    <select id="aa-mode">
                        <option value="0">None</option>
                        <option value="1" selected>FXAA</option>
                        <option value="2">SMAA</option>
                        <option value="3">TAA</option>
                    </select>
                </label>
            </div>
            <div id="fxaa-options" class="section">
                <h3>FXAA Options</h3>
                <label>
                    Quality
                    <select id="fxaa-quality">
                        <option value="0">Low</option>
                        <option value="1">Medium</option>
                        <option value="2" selected>High</option>
                    </select>
                </label>
            </div>
            <div id="smaa-options" class="section" style="display: none;">
                <h3>SMAA Options</h3>
                <label>
                    Quality
                    <select id="smaa-quality">
                        <option value="0">Low</option>
                        <option value="1">Medium</option>
                        <option value="2" selected>High</option>
                        <option value="3">Ultra</option>
                    </select>
                </label>
            </div>
            <div id="taa-options" class="section" style="display: none;">
                <h3>TAA Options</h3>
                <label>
                    Blend
                    <input type="range" id="taa-blend" min="0.5" max="0.98" step="0.02" value="0.9">
                    <span class="value" id="taa-blend-val">0.9</span>
                </label>
                <label>
                    Sharpness
                    <input type="range" id="taa-sharpness" min="0" max="1" step="0.1" value="0.2">
                    <span class="value" id="taa-sharpness-val">0.2</span>
                </label>
            </div>
        </div>

        <!-- Scene Tab -->
        <div class="tab-content" id="tab-scene">
            <div class="section">
                <h3>SSAO</h3>
                <label>
                    <input type="checkbox" id="ssao-enabled" checked>
                    Enable
                </label>
                <label>
                    Quality
                    <select id="ssao-quality">
                        <option value="0">Low</option>
                        <option value="1" selected>Medium</option>
                        <option value="2">High</option>
                        <option value="3">Ultra</option>
                    </select>
                </label>
                <label>
                    Radius
                    <input type="range" id="ssao-radius" min="0.1" max="2" step="0.1" value="0.5">
                    <span class="value" id="ssao-radius-val">0.5</span>
                </label>
                <label>
                    Intensity
                    <input type="range" id="ssao-intensity" min="0" max="3" step="0.1" value="1.0">
                    <span class="value" id="ssao-intensity-val">1.0</span>
                </label>
                <label>
                    Bias
                    <input type="range" id="ssao-bias" min="0" max="0.1" step="0.005" value="0.025">
                    <span class="value" id="ssao-bias-val">0.025</span>
                </label>
                <button id="ssao-reset" style="margin-top: 5px; padding: 5px 10px; background: #444; border: none; color: #fff; border-radius: 3px; cursor: pointer;">Reset SSAO</button>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>GTAO (Ground Truth AO)</h3>
                <p style="font-size: 11px; color: #888; margin-bottom: 8px;">More accurate than SSAO. Enabling disables SSAO.</p>
                <label>
                    <input type="checkbox" id="gtao-enabled">
                    Enable
                </label>
                <label>
                    Quality
                    <select id="gtao-quality">
                        <option value="0">Low</option>
                        <option value="1" selected>Medium</option>
                        <option value="2">High</option>
                        <option value="3">Ultra</option>
                    </select>
                </label>
                <label>
                    Radius
                    <input type="range" id="gtao-radius" min="0.1" max="2" step="0.1" value="0.5">
                    <span class="value" id="gtao-radius-val">0.5</span>
                </label>
                <label>
                    Intensity
                    <input type="range" id="gtao-intensity" min="0.5" max="3" step="0.1" value="1.5">
                    <span class="value" id="gtao-intensity-val">1.5</span>
                </label>
                <label>
                    Power
                    <input type="range" id="gtao-power" min="0.5" max="4" step="0.1" value="1.5">
                    <span class="value" id="gtao-power-val">1.5</span>
                </label>
                <label>
                    Falloff
                    <input type="range" id="gtao-falloff" min="0" max="1" step="0.05" value="0.2">
                    <span class="value" id="gtao-falloff-val">0.2</span>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Lumen GI (Global Illumination)</h3>
                <p style="font-size: 11px; color: #888; margin-bottom: 8px;">Screen-space global illumination for indirect lighting.</p>
                <label>
                    <input type="checkbox" id="lumen-enabled">
                    Enable
                </label>
                <label>
                    Quality
                    <select id="lumen-quality">
                        <option value="0">Low</option>
                        <option value="1" selected>Medium</option>
                        <option value="2">High</option>
                        <option value="3">Ultra</option>
                    </select>
                </label>
                <label>
                    Intensity
                    <input type="range" id="lumen-intensity" min="0" max="3" step="0.1" value="1.0">
                    <span class="value" id="lumen-intensity-val">1.0</span>
                </label>
                <label>
                    Max Distance
                    <input type="range" id="lumen-distance" min="1" max="20" step="0.5" value="5.0">
                    <span class="value" id="lumen-distance-val">5.0</span>
                </label>
                <label>
                    Thickness
                    <input type="range" id="lumen-thickness" min="0.01" max="0.5" step="0.01" value="0.1">
                    <span class="value" id="lumen-thickness-val">0.10</span>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Volumetric Fog</h3>
                <p style="font-size: 11px; color: #888; margin-bottom: 8px;">Atmospheric fog with god rays and light scattering.</p>
                <label>
                    <input type="checkbox" id="fog-enabled">
                    Enable
                </label>
                <label>
                    Quality
                    <select id="fog-quality">
                        <option value="0">Low</option>
                        <option value="1" selected>Medium</option>
                        <option value="2">High</option>
                        <option value="3">Ultra</option>
                    </select>
                </label>
                <label>
                    Density
                    <input type="range" id="fog-density" min="0" max="1" step="0.01" value="0.02">
                    <span class="value" id="fog-density-val">0.02</span>
                </label>
                <label>
                    Max Distance
                    <input type="range" id="fog-distance" min="10" max="500" step="10" value="100">
                    <span class="value" id="fog-distance-val">100</span>
                </label>
                <label>
                    Height Falloff
                    <input type="range" id="fog-height" min="0" max="0.5" step="0.01" value="0.1">
                    <span class="value" id="fog-height-val">0.10</span>
                </label>
                <label>
                    Scattering
                    <input type="range" id="fog-scattering" min="0" max="1" step="0.01" value="0.7">
                    <span class="value" id="fog-scattering-val">0.70</span>
                </label>
                <label>
                    <input type="checkbox" id="fog-godrays" checked>
                    God Rays
                </label>
                <label>
                    God Ray Intensity
                    <input type="range" id="fog-godray-intensity" min="0" max="3" step="0.1" value="1.0">
                    <span class="value" id="fog-godray-intensity-val">1.0</span>
                </label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>IBL (Environment Lighting)</h3>
                <label>
                    Diffuse
                    <input type="range" id="ibl-diffuse" min="0" max="2" step="0.1" value="0.3">
                    <span class="value" id="ibl-diffuse-val">0.3</span>
                </label>
                <label>
                    Specular
                    <input type="range" id="ibl-specular" min="0" max="2" step="0.1" value="1.0">
                    <span class="value" id="ibl-specular-val">1.0</span>
                </label>
                <button id="ibl-reset" style="margin-top: 5px; padding: 5px 10px; background: #444; border: none; color: #fff; border-radius: 3px; cursor: pointer;">Reset IBL</button>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Scene Lights</h3>
                <label>
                    Preset
                    <select id="light-preset">
                        <option value="studio" selected>Car Studio</option>
                        <option value="outdoor">Outdoor</option>
                        <option value="dramatic">Dramatic</option>
                    </select>
                </label>
                <div style="margin-top: 10px; font-size: 11px; color: #aaa;">Key Light</div>
                <label><input type="checkbox" id="light0-enabled" checked> Enable</label>
                <label>Intensity <input type="range" id="light0-intensity" min="0" max="30" step="1" value="15"><span class="value" id="light0-intensity-val">15</span></label>
                <label>Color <input type="color" id="light0-color" value="#fffaf2"></label>
                <label>X <input type="range" id="light0-x" min="-15" max="15" step="0.5" value="5"><span class="value" id="light0-x-val">5</span></label>
                <label>Y <input type="range" id="light0-y" min="0" max="20" step="0.5" value="8"><span class="value" id="light0-y-val">8</span></label>
                <label>Z <input type="range" id="light0-z" min="-15" max="15" step="0.5" value="5"><span class="value" id="light0-z-val">5</span></label>
                <div style="margin-top: 10px; font-size: 11px; color: #aaa;">Fill Light</div>
                <label><input type="checkbox" id="light1-enabled" checked> Enable</label>
                <label>Intensity <input type="range" id="light1-intensity" min="0" max="30" step="1" value="10"><span class="value" id="light1-intensity-val">10</span></label>
                <label>Color <input type="color" id="light1-color" value="#e6f2ff"></label>
                <label>X <input type="range" id="light1-x" min="-15" max="15" step="0.5" value="-5"><span class="value" id="light1-x-val">-5</span></label>
                <label>Y <input type="range" id="light1-y" min="0" max="20" step="0.5" value="6"><span class="value" id="light1-y-val">6</span></label>
                <label>Z <input type="range" id="light1-z" min="-15" max="15" step="0.5" value="3"><span class="value" id="light1-z-val">3</span></label>
                <div style="margin-top: 10px; font-size: 11px; color: #aaa;">Rim Light</div>
                <label><input type="checkbox" id="light2-enabled" checked> Enable</label>
                <label>Intensity <input type="range" id="light2-intensity" min="0" max="30" step="1" value="8"><span class="value" id="light2-intensity-val">8</span></label>
                <label>Color <input type="color" id="light2-color" value="#ffffff"></label>
                <label>X <input type="range" id="light2-x" min="-15" max="15" step="0.5" value="0"><span class="value" id="light2-x-val">0</span></label>
                <label>Y <input type="range" id="light2-y" min="0" max="20" step="0.5" value="4"><span class="value" id="light2-y-val">4</span></label>
                <label>Z <input type="range" id="light2-z" min="-15" max="15" step="0.5" value="-6"><span class="value" id="light2-z-val">-6</span></label>
                <div style="margin-top: 10px; font-size: 11px; color: #aaa;">Bounce Light</div>
                <label><input type="checkbox" id="light3-enabled" checked> Enable</label>
                <label>Intensity <input type="range" id="light3-intensity" min="0" max="30" step="1" value="5"><span class="value" id="light3-intensity-val">5</span></label>
                <label>Color <input type="color" id="light3-color" value="#ccd9e6"></label>
                <label>X <input type="range" id="light3-x" min="-15" max="15" step="0.5" value="-3"><span class="value" id="light3-x-val">-3</span></label>
                <label>Y <input type="range" id="light3-y" min="0" max="20" step="0.5" value="1"><span class="value" id="light3-y-val">1</span></label>
                <label>Z <input type="range" id="light3-z" min="-15" max="15" step="0.5" value="-3"><span class="value" id="light3-z-val">-3</span></label>
            </div>
            <hr class="divider">
            <div class="section">
                <h3>Helpers</h3>
                <label>
                    <input type="checkbox" id="show-grid" checked>
                    Show Grid
                </label>
                <label>
                    <input type="checkbox" id="show-axes" checked>
                    Show Axes
                </label>
            </div>
        </div>
    </div>

    <script type="module">
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        async function init() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const statsEl = document.getElementById('stats');
            const canvas = document.getElementById('canvas');

            try {
                // Check for WebGPU support
                if (!navigator.gpu) {
                    throw new Error(
                        'WebGPU is not supported in your browser.\n\n' +
                        'Try using Chrome 113+, Edge 113+, or Firefox Nightly with dom.webgpu.enabled set to true.'
                    );
                }

                // Request adapter
                const adapter = await navigator.gpu.requestAdapter();
                if (!adapter) {
                    throw new Error('Failed to get WebGPU adapter. Your GPU may not be supported.');
                }

                // Load WASM module
                const { default: init, RenApp } = await import('./pkg/ren.js');
                await init();

                loadingEl.style.display = 'none';

                // Create and run the app
                const app = await RenApp.new('canvas');

                let lastTime = performance.now();
                let frameCount = 0;
                let fps = 0;
                const keysPressed = {};

                // Animation loop
                function frame() {
                    // Handle keyboard movement (WASD + QE)
                    let forward = 0, right = 0, up = 0;
                    if (keysPressed['KeyW']) forward += 1;
                    if (keysPressed['KeyS']) forward -= 1;
                    if (keysPressed['KeyA']) right -= 1;
                    if (keysPressed['KeyD']) right += 1;
                    if (keysPressed['KeyE']) up += 1;
                    if (keysPressed['KeyQ']) up -= 1;
                    if (forward !== 0 || right !== 0 || up !== 0) {
                        app.on_keyboard_move(forward, right, up);
                    }

                    app.frame();
                    frameCount++;

                    const now = performance.now();
                    if (now - lastTime >= 1000) {
                        fps = frameCount;
                        frameCount = 0;
                        lastTime = now;

                        const stats = app.stats();
                        statsEl.innerHTML = `
                            FPS: ${fps}<br>
                            Draw Calls: ${stats.draw_calls}<br>
                            Triangles: ${stats.triangles}<br>
                            Frame: ${stats.frame}
                        `;
                    }

                    requestAnimationFrame(frame);
                }
                requestAnimationFrame(frame);

                // Handle resize
                window.addEventListener('resize', () => {
                    app.resize(window.innerWidth, window.innerHeight);
                });

                // Mouse controls
                let isDragging = false;
                let isPanning = false;
                let lastMouseX = 0;
                let lastMouseY = 0;

                canvas.addEventListener('mousedown', (e) => {
                    if (e.button === 0) {
                        if (e.shiftKey) {
                            isPanning = true;
                        } else {
                            isDragging = true;
                        }
                    } else if (e.button === 2) {
                        isPanning = true;
                    }
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;
                    e.preventDefault();
                });

                window.addEventListener('mouseup', () => {
                    isDragging = false;
                    isPanning = false;
                });

                window.addEventListener('mousemove', (e) => {
                    const deltaX = e.clientX - lastMouseX;
                    const deltaY = e.clientY - lastMouseY;
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;

                    if (isDragging) {
                        app.on_mouse_drag(deltaX, deltaY);
                    } else if (isPanning) {
                        app.on_mouse_pan(deltaX, deltaY);
                    }
                });

                canvas.addEventListener('wheel', (e) => {
                    app.on_mouse_wheel(e.deltaY);
                    e.preventDefault();
                }, { passive: false });

                canvas.addEventListener('contextmenu', (e) => e.preventDefault());

                // Keyboard controls (WASD + QE)
                window.addEventListener('keydown', (e) => {
                    // Don't capture keys when typing in inputs
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                    keysPressed[e.code] = true;
                });
                window.addEventListener('keyup', (e) => {
                    keysPressed[e.code] = false;
                });

                // Model loading
                const modelInput = document.getElementById('model-input');
                const clearBtn = document.getElementById('clear-btn');

                modelInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        const ext = file.name.split('.').pop().toLowerCase();

                        if (ext === 'glb' || ext === 'gltf') {
                            const arrayBuffer = await file.arrayBuffer();
                            const data = new Uint8Array(arrayBuffer);
                            const count = app.load_gltf(data);
                            console.log(`Loaded ${count} mesh(es) from ${file.name}`);
                        } else if (ext === 'obj') {
                            const text = await file.text();
                            const count = app.load_obj(text);
                            console.log(`Loaded ${count} mesh(es) from ${file.name}`);
                        }
                    } catch (err) {
                        console.error('Failed to load model:', err);
                        alert('Failed to load model: ' + err);
                    }
                    modelInput.value = '';
                });

                clearBtn.addEventListener('click', () => {
                    app.clear_loaded_meshes();
                    console.log('Cleared loaded models');
                });

                const demoBtn = document.getElementById('demo-btn');
                demoBtn.addEventListener('click', () => {
                    app.add_demo_shapes();
                    console.log('Added demo shapes');
                });

                app.add_demo_shapes();

                // Add floor plane (y=0, size=20, gray color, non-metallic, slightly rough)
                app.add_floor(0.0, 20.0, 0.3, 0.3, 0.3, 0.0, 0.7);

                // Bloom controls
                document.getElementById('bloom-enabled').addEventListener('change', (e) => {
                    app.set_bloom_enabled(e.target.checked);
                });
                document.getElementById('bloom-intensity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_bloom_intensity(val);
                    document.getElementById('bloom-intensity-val').textContent = val.toFixed(1);
                });
                document.getElementById('bloom-threshold').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_bloom_threshold(val);
                    document.getElementById('bloom-threshold-val').textContent = val.toFixed(2);
                });
                document.getElementById('exposure').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_exposure(val);
                    document.getElementById('exposure-val').textContent = val.toFixed(1);
                });

                // Auto-Exposure
                document.getElementById('auto-exposure-enabled').addEventListener('change', (e) => {
                    app.set_auto_exposure_enabled(e.target.checked);
                    // Disable manual exposure slider when auto is on
                    document.getElementById('exposure').disabled = e.target.checked;
                });
                document.getElementById('auto-exposure-compensation').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_auto_exposure_compensation(val);
                    document.getElementById('auto-exposure-compensation-val').textContent = val.toFixed(1);
                });
                document.getElementById('auto-exposure-speed-up').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_auto_exposure_speed_up(val);
                    document.getElementById('auto-exposure-speed-up-val').textContent = val.toFixed(1);
                });
                document.getElementById('auto-exposure-speed-down').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_auto_exposure_speed_down(val);
                    document.getElementById('auto-exposure-speed-down-val').textContent = val.toFixed(1);
                });

                // HDR Display
                const hdrCheckbox = document.getElementById('hdr-output');
                const hdrStatus = document.getElementById('hdr-status');
                if (app.has_hdr_display()) {
                    hdrCheckbox.disabled = false;
                    const format = app.get_hdr_display_format();
                    hdrStatus.textContent = 'Available: ' + format;
                    hdrStatus.style.color = '#4a4';
                } else {
                    hdrStatus.textContent = 'Not available (8-bit display)';
                    hdrStatus.style.color = '#888';
                }
                hdrCheckbox.addEventListener('change', (e) => {
                    const success = app.set_hdr_output_enabled(e.target.checked);
                    if (!success) {
                        e.target.checked = false;
                        hdrStatus.textContent = 'Failed to enable HDR';
                    } else {
                        hdrStatus.textContent = e.target.checked ? 'HDR output active' : 'SDR output';
                    }
                });

                // Render mode control
                document.getElementById('render-mode').addEventListener('change', (e) => {
                    app.set_render_mode(parseInt(e.target.value));
                });

                // AA controls
                const aaMode = document.getElementById('aa-mode');
                function updateAAOptions() {
                    const mode = parseInt(aaMode.value);
                    document.getElementById('fxaa-options').style.display = mode === 1 ? 'block' : 'none';
                    document.getElementById('smaa-options').style.display = mode === 2 ? 'block' : 'none';
                    document.getElementById('taa-options').style.display = mode === 3 ? 'block' : 'none';
                }
                aaMode.addEventListener('change', (e) => {
                    app.set_aa_mode(parseInt(e.target.value));
                    updateAAOptions();
                });
                document.getElementById('fxaa-quality').addEventListener('change', (e) => {
                    app.set_fxaa_quality(parseInt(e.target.value));
                });
                document.getElementById('smaa-quality').addEventListener('change', (e) => {
                    app.set_smaa_quality(parseInt(e.target.value));
                });
                document.getElementById('taa-blend').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_taa_blend_factor(val);
                    document.getElementById('taa-blend-val').textContent = val.toFixed(2);
                });
                document.getElementById('taa-sharpness').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_taa_sharpness(val);
                    document.getElementById('taa-sharpness-val').textContent = val.toFixed(1);
                });

                // Helper controls
                document.getElementById('show-grid').addEventListener('change', (e) => {
                    app.set_grid_visible(e.target.checked);
                });
                document.getElementById('show-axes').addEventListener('change', (e) => {
                    app.set_axes_visible(e.target.checked);
                });

                // SSAO controls
                document.getElementById('ssao-enabled').addEventListener('change', (e) => {
                    app.set_ssao_enabled(e.target.checked);
                });
                document.getElementById('ssao-quality').addEventListener('change', (e) => {
                    app.set_ssao_quality(parseInt(e.target.value));
                });
                document.getElementById('ssao-radius').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_ssao_radius(val);
                    document.getElementById('ssao-radius-val').textContent = val.toFixed(1);
                });
                document.getElementById('ssao-intensity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_ssao_intensity(val);
                    document.getElementById('ssao-intensity-val').textContent = val.toFixed(1);
                });

                // Vignette controls
                document.getElementById('vignette-enabled').addEventListener('change', (e) => {
                    app.set_vignette_enabled(e.target.checked);
                });
                document.getElementById('vignette-intensity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_vignette_intensity(val);
                    document.getElementById('vignette-intensity-val').textContent = val.toFixed(2);
                });
                document.getElementById('vignette-smoothness').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_vignette_smoothness(val);
                    document.getElementById('vignette-smoothness-val').textContent = val.toFixed(2);
                });
                document.getElementById('vignette-roundness').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_vignette_roundness(val);
                    document.getElementById('vignette-roundness-val').textContent = val.toFixed(1);
                });

                // Shadow controls
                document.getElementById('shadows-enabled').addEventListener('change', (e) => {
                    if (app.set_shadows_enabled) app.set_shadows_enabled(e.target.checked);
                });
                document.getElementById('shadow-resolution').addEventListener('change', (e) => {
                    if (app.set_shadow_resolution) app.set_shadow_resolution(parseInt(e.target.value));
                });
                document.getElementById('shadow-pcf').addEventListener('change', (e) => {
                    const val = parseInt(e.target.value);
                    if (app.set_shadow_pcf_mode) app.set_shadow_pcf_mode(val);
                    // Show/hide PCSS controls based on mode
                    document.getElementById('pcss-controls').style.display = (val === 5) ? 'block' : 'none';
                });
                document.getElementById('shadow-bias').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_shadow_bias) app.set_shadow_bias(val);
                    document.getElementById('shadow-bias-val').textContent = val.toFixed(3);
                });
                document.getElementById('shadow-normal-bias').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_shadow_normal_bias) app.set_shadow_normal_bias(val);
                    document.getElementById('shadow-normal-bias-val').textContent = val.toFixed(3);
                });
                // PCSS controls
                document.getElementById('pcss-light-size').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_pcss_light_size) app.set_pcss_light_size(val);
                    document.getElementById('pcss-light-size-val').textContent = val.toFixed(1);
                });
                document.getElementById('pcss-max-radius').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_pcss_max_filter_radius) app.set_pcss_max_filter_radius(val);
                    document.getElementById('pcss-max-radius-val').textContent = val.toFixed(0);
                });
                // Contact shadow controls
                document.getElementById('contact-shadows-enabled').addEventListener('change', (e) => {
                    if (app.set_contact_shadows_enabled) app.set_contact_shadows_enabled(e.target.checked);
                });
                document.getElementById('contact-shadow-distance').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_contact_shadow_distance) app.set_contact_shadow_distance(val);
                    document.getElementById('contact-shadow-distance-val').textContent = val.toFixed(2);
                });
                document.getElementById('contact-shadow-thickness').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_contact_shadow_thickness) app.set_contact_shadow_thickness(val);
                    document.getElementById('contact-shadow-thickness-val').textContent = val.toFixed(2);
                });
                document.getElementById('contact-shadow-intensity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_contact_shadow_intensity) app.set_contact_shadow_intensity(val);
                    document.getElementById('contact-shadow-intensity-val').textContent = val.toFixed(2);
                });
                document.getElementById('shadow-cascades').addEventListener('change', (e) => {
                    if (app.set_shadow_cascades) app.set_shadow_cascades(parseInt(e.target.value));
                });

                // Shadow light type
                document.getElementById('shadow-light-type').addEventListener('change', (e) => {
                    const val = parseInt(e.target.value);
                    if (app.set_shadow_light_type) app.set_shadow_light_type(val);
                    // Show/hide spot controls
                    document.getElementById('spot-controls').style.display = (val === 1 || val === 2) ? 'block' : 'none';
                });

                // Spot light controls
                document.getElementById('spot-pos-x').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    document.getElementById('spot-pos-x-val').textContent = val.toFixed(1);
                    if (app.set_spot_position) {
                        app.set_spot_position(
                            val,
                            parseFloat(document.getElementById('spot-pos-y').value),
                            parseFloat(document.getElementById('spot-pos-z').value)
                        );
                    }
                });
                document.getElementById('spot-pos-y').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    document.getElementById('spot-pos-y-val').textContent = val.toFixed(1);
                    if (app.set_spot_position) {
                        app.set_spot_position(
                            parseFloat(document.getElementById('spot-pos-x').value),
                            val,
                            parseFloat(document.getElementById('spot-pos-z').value)
                        );
                    }
                });
                document.getElementById('spot-pos-z').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    document.getElementById('spot-pos-z-val').textContent = val.toFixed(1);
                    if (app.set_spot_position) {
                        app.set_spot_position(
                            parseFloat(document.getElementById('spot-pos-x').value),
                            parseFloat(document.getElementById('spot-pos-y').value),
                            val
                        );
                    }
                });
                document.getElementById('spot-range').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    document.getElementById('spot-range-val').textContent = val.toFixed(0);
                    if (app.set_spot_range) app.set_spot_range(val);
                });
                document.getElementById('spot-inner-angle').addEventListener('input', (e) => {
                    const inner = parseFloat(e.target.value);
                    document.getElementById('spot-inner-angle-val').textContent = inner + '°';
                    const outer = parseFloat(document.getElementById('spot-outer-angle').value);
                    if (app.set_spot_angles) app.set_spot_angles(inner, Math.max(inner + 5, outer));
                });
                document.getElementById('spot-outer-angle').addEventListener('input', (e) => {
                    const outer = parseFloat(e.target.value);
                    document.getElementById('spot-outer-angle-val').textContent = outer + '°';
                    const inner = parseFloat(document.getElementById('spot-inner-angle').value);
                    if (app.set_spot_angles) app.set_spot_angles(Math.min(inner, outer - 5), outer);
                });

                // DoF controls
                document.getElementById('dof-enabled').addEventListener('change', (e) => {
                    app.set_dof_enabled(e.target.checked);
                });
                document.getElementById('dof-quality').addEventListener('change', (e) => {
                    app.set_dof_quality(parseInt(e.target.value));
                });
                document.getElementById('dof-focal-distance').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_dof_focal_distance(val);
                    document.getElementById('dof-focal-distance-val').textContent = val.toFixed(1);
                });
                document.getElementById('dof-focal-range').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_dof_focal_range(val);
                    document.getElementById('dof-focal-range-val').textContent = val.toFixed(1);
                });
                document.getElementById('dof-blur-strength').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_dof_blur_strength(val);
                    document.getElementById('dof-blur-strength-val').textContent = val.toFixed(1);
                    saveSettings();
                });
                document.getElementById('dof-highlight-boost').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_dof_highlight_boost) app.set_dof_highlight_boost(val);
                    document.getElementById('dof-highlight-boost-val').textContent = val.toFixed(1);
                    saveSettings();
                });
                document.getElementById('dof-highlight-threshold').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_dof_highlight_threshold) app.set_dof_highlight_threshold(val);
                    document.getElementById('dof-highlight-threshold-val').textContent = val.toFixed(2);
                    saveSettings();
                });

                // SSR controls
                document.getElementById('ssr-enabled').addEventListener('change', (e) => {
                    app.set_ssr_enabled(e.target.checked);
                });
                document.getElementById('ssr-quality').addEventListener('change', (e) => {
                    app.set_ssr_quality(parseInt(e.target.value));
                });
                document.getElementById('ssr-max-distance').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_ssr_max_distance(val);
                    document.getElementById('ssr-max-distance-val').textContent = val.toFixed(0);
                });
                document.getElementById('ssr-thickness').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_ssr_thickness(val);
                    document.getElementById('ssr-thickness-val').textContent = val.toFixed(2);
                });
                document.getElementById('ssr-intensity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_ssr_intensity(val);
                    document.getElementById('ssr-intensity-val').textContent = val.toFixed(2);
                });

                // Motion blur controls
                document.getElementById('motion-blur-enabled').addEventListener('change', (e) => {
                    app.set_motion_blur_enabled(e.target.checked);
                });
                document.getElementById('motion-blur-quality').addEventListener('change', (e) => {
                    app.set_motion_blur_quality(parseInt(e.target.value));
                });
                document.getElementById('motion-blur-intensity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_motion_blur_intensity(val);
                    document.getElementById('motion-blur-intensity-val').textContent = val.toFixed(1);
                });
                document.getElementById('motion-blur-max').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_motion_blur_max(val);
                    document.getElementById('motion-blur-max-val').textContent = val.toFixed(0);
                });
                document.getElementById('motion-blur-velocity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_motion_blur_velocity_scale(val);
                    document.getElementById('motion-blur-velocity-val').textContent = val.toFixed(1);
                });

                // Outline controls
                document.getElementById('outline-enabled').addEventListener('change', (e) => {
                    app.set_outline_enabled(e.target.checked);
                });
                document.getElementById('outline-mode').addEventListener('change', (e) => {
                    app.set_outline_mode(parseInt(e.target.value));
                });
                document.getElementById('outline-thickness').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_outline_thickness(val);
                    document.getElementById('outline-thickness-val').textContent = val.toFixed(1);
                });
                document.getElementById('outline-depth').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_outline_depth_threshold(val);
                    document.getElementById('outline-depth-val').textContent = val.toFixed(2);
                });
                document.getElementById('outline-normal').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_outline_normal_threshold(val);
                    document.getElementById('outline-normal-val').textContent = val.toFixed(2);
                });
                document.getElementById('outline-color').addEventListener('input', (e) => {
                    const hex = e.target.value;
                    const r = parseInt(hex.substr(1, 2), 16) / 255;
                    const g = parseInt(hex.substr(3, 2), 16) / 255;
                    const b = parseInt(hex.substr(5, 2), 16) / 255;
                    app.set_outline_color(r, g, b);
                });

                // Color correction controls
                document.getElementById('cc-enabled').addEventListener('change', (e) => {
                    app.set_color_correction_enabled(e.target.checked);
                });
                document.getElementById('cc-brightness').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_cc_brightness(val);
                    document.getElementById('cc-brightness-val').textContent = val.toFixed(2);
                });
                document.getElementById('cc-contrast').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_cc_contrast(val);
                    document.getElementById('cc-contrast-val').textContent = val.toFixed(2);
                });
                document.getElementById('cc-saturation').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_cc_saturation(val);
                    document.getElementById('cc-saturation-val').textContent = val.toFixed(2);
                });
                document.getElementById('cc-gamma').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_cc_gamma(val);
                    document.getElementById('cc-gamma-val').textContent = val.toFixed(2);
                });
                document.getElementById('cc-temperature').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_cc_temperature(val);
                    document.getElementById('cc-temperature-val').textContent = val.toFixed(2);
                });
                document.getElementById('cc-tint').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_cc_tint(val);
                    document.getElementById('cc-tint-val').textContent = val.toFixed(2);
                });
                document.getElementById('cc-reset').addEventListener('click', () => {
                    app.reset_color_correction();
                    document.getElementById('cc-brightness').value = 0;
                    document.getElementById('cc-brightness-val').textContent = '0.00';
                    document.getElementById('cc-contrast').value = 1;
                    document.getElementById('cc-contrast-val').textContent = '1.00';
                    document.getElementById('cc-saturation').value = 1;
                    document.getElementById('cc-saturation-val').textContent = '1.00';
                    document.getElementById('cc-gamma').value = 1;
                    document.getElementById('cc-gamma-val').textContent = '1.00';
                    document.getElementById('cc-temperature').value = 0;
                    document.getElementById('cc-temperature-val').textContent = '0.00';
                    document.getElementById('cc-tint').value = 0;
                    document.getElementById('cc-tint-val').textContent = '0.00';
                });

                // Hemisphere light controls
                document.getElementById('hemisphere-enabled').addEventListener('change', (e) => {
                    app.set_hemisphere_light_enabled(e.target.checked);
                });
                document.getElementById('hemisphere-sky-color').addEventListener('input', (e) => {
                    const hex = e.target.value;
                    const r = parseInt(hex.substr(1, 2), 16) / 255;
                    const g = parseInt(hex.substr(3, 2), 16) / 255;
                    const b = parseInt(hex.substr(5, 2), 16) / 255;
                    app.set_hemisphere_sky_color(r, g, b);
                });
                document.getElementById('hemisphere-ground-color').addEventListener('input', (e) => {
                    const hex = e.target.value;
                    const r = parseInt(hex.substr(1, 2), 16) / 255;
                    const g = parseInt(hex.substr(3, 2), 16) / 255;
                    const b = parseInt(hex.substr(5, 2), 16) / 255;
                    app.set_hemisphere_ground_color(r, g, b);
                });
                document.getElementById('hemisphere-intensity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_hemisphere_intensity(val);
                    document.getElementById('hemisphere-intensity-val').textContent = val.toFixed(1);
                });

                // Skybox controls
                document.getElementById('skybox-enabled').addEventListener('change', (e) => {
                    app.set_skybox_enabled(e.target.checked);
                });
                document.getElementById('skybox-exposure').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    app.set_skybox_exposure(val);
                    document.getElementById('skybox-exposure-val').textContent = val.toFixed(1);
                });

                // Helper to convert hex color to RGB
                const hexToRgb = (hex) => {
                    const r = parseInt(hex.slice(1, 3), 16);
                    const g = parseInt(hex.slice(3, 5), 16);
                    const b = parseInt(hex.slice(5, 7), 16);
                    return [r, g, b];
                };

                const updateSkyColors = () => {
                    const sky = hexToRgb(document.getElementById('skybox-sky-color').value);
                    const horizon = hexToRgb(document.getElementById('skybox-horizon-color').value);
                    const ground = hexToRgb(document.getElementById('skybox-ground-color').value);
                    app.set_sky_colors(sky[0], sky[1], sky[2], horizon[0], horizon[1], horizon[2], ground[0], ground[1], ground[2]);
                };

                document.getElementById('skybox-sky-color').addEventListener('input', updateSkyColors);
                document.getElementById('skybox-horizon-color').addEventListener('input', updateSkyColors);
                document.getElementById('skybox-ground-color').addEventListener('input', updateSkyColors);

                // HDR environment map file input
                document.getElementById('skybox-hdr-file').addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const loadingEl = document.getElementById('hdr-loading');
                    loadingEl.style.display = 'block';
                    loadingEl.textContent = 'Loading HDR...';

                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const data = new Uint8Array(arrayBuffer);
                        await app.set_skybox_hdr(data);
                        loadingEl.textContent = 'HDR loaded: ' + file.name;
                        setTimeout(() => { loadingEl.style.display = 'none'; }, 2000);
                    } catch (err) {
                        loadingEl.textContent = 'Error: ' + err;
                        console.error('HDR load error:', err);
                    }
                });

                // SSAO bias control
                document.getElementById('ssao-bias').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_ssao_bias) app.set_ssao_bias(val);
                    document.getElementById('ssao-bias-val').textContent = val.toFixed(3);
                    saveSettings();
                });

                // SSAO reset
                document.getElementById('ssao-reset').addEventListener('click', () => {
                    document.getElementById('ssao-enabled').checked = true;
                    document.getElementById('ssao-quality').value = '1';
                    document.getElementById('ssao-radius').value = 0.5;
                    document.getElementById('ssao-radius-val').textContent = '0.5';
                    document.getElementById('ssao-intensity').value = 1.0;
                    document.getElementById('ssao-intensity-val').textContent = '1.0';
                    document.getElementById('ssao-bias').value = 0.025;
                    document.getElementById('ssao-bias-val').textContent = '0.025';
                    app.set_ssao_enabled(true);
                    app.set_ssao_quality(1);
                    app.set_ssao_radius(0.5);
                    app.set_ssao_intensity(1.0);
                    if (app.set_ssao_bias) app.set_ssao_bias(0.025);
                    saveSettings();
                });

                // GTAO controls
                document.getElementById('gtao-enabled').addEventListener('change', (e) => {
                    if (app.set_gtao_enabled) {
                        app.set_gtao_enabled(e.target.checked);
                        // Uncheck SSAO when GTAO is enabled (they're mutually exclusive)
                        if (e.target.checked) {
                            document.getElementById('ssao-enabled').checked = false;
                        }
                    }
                    saveSettings();
                });
                document.getElementById('gtao-quality').addEventListener('change', (e) => {
                    if (app.set_gtao_quality) app.set_gtao_quality(parseInt(e.target.value));
                    saveSettings();
                });
                document.getElementById('gtao-radius').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_gtao_radius) app.set_gtao_radius(val);
                    document.getElementById('gtao-radius-val').textContent = val.toFixed(1);
                    saveSettings();
                });
                document.getElementById('gtao-intensity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_gtao_intensity) app.set_gtao_intensity(val);
                    document.getElementById('gtao-intensity-val').textContent = val.toFixed(1);
                    saveSettings();
                });
                document.getElementById('gtao-power').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_gtao_power) app.set_gtao_power(val);
                    document.getElementById('gtao-power-val').textContent = val.toFixed(1);
                    saveSettings();
                });
                document.getElementById('gtao-falloff').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_gtao_falloff) app.set_gtao_falloff(val);
                    document.getElementById('gtao-falloff-val').textContent = val.toFixed(2);
                    saveSettings();
                });

                // Lumen GI controls
                document.getElementById('lumen-enabled').addEventListener('change', (e) => {
                    if (app.set_lumen_enabled) app.set_lumen_enabled(e.target.checked);
                    saveSettings();
                });
                document.getElementById('lumen-quality').addEventListener('change', (e) => {
                    if (app.set_lumen_quality) app.set_lumen_quality(parseInt(e.target.value));
                    saveSettings();
                });
                document.getElementById('lumen-intensity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_lumen_intensity) app.set_lumen_intensity(val);
                    document.getElementById('lumen-intensity-val').textContent = val.toFixed(1);
                    saveSettings();
                });
                document.getElementById('lumen-distance').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_lumen_max_distance) app.set_lumen_max_distance(val);
                    document.getElementById('lumen-distance-val').textContent = val.toFixed(1);
                    saveSettings();
                });
                document.getElementById('lumen-thickness').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_lumen_thickness) app.set_lumen_thickness(val);
                    document.getElementById('lumen-thickness-val').textContent = val.toFixed(2);
                    saveSettings();
                });

                // Volumetric Fog controls
                document.getElementById('fog-enabled').addEventListener('change', (e) => {
                    if (app.set_volumetric_fog_enabled) app.set_volumetric_fog_enabled(e.target.checked);
                    saveSettings();
                });
                document.getElementById('fog-quality').addEventListener('change', (e) => {
                    if (app.set_volumetric_fog_quality) app.set_volumetric_fog_quality(parseInt(e.target.value));
                    saveSettings();
                });
                document.getElementById('fog-density').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_volumetric_fog_density) app.set_volumetric_fog_density(val);
                    document.getElementById('fog-density-val').textContent = val.toFixed(2);
                    saveSettings();
                });
                document.getElementById('fog-distance').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_volumetric_fog_max_distance) app.set_volumetric_fog_max_distance(val);
                    document.getElementById('fog-distance-val').textContent = val.toFixed(0);
                    saveSettings();
                });
                document.getElementById('fog-height').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_volumetric_fog_height_falloff) app.set_volumetric_fog_height_falloff(val);
                    document.getElementById('fog-height-val').textContent = val.toFixed(2);
                    saveSettings();
                });
                document.getElementById('fog-scattering').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_volumetric_fog_scattering) app.set_volumetric_fog_scattering(val);
                    document.getElementById('fog-scattering-val').textContent = val.toFixed(2);
                    saveSettings();
                });
                document.getElementById('fog-godrays').addEventListener('change', (e) => {
                    if (app.set_volumetric_fog_god_rays) app.set_volumetric_fog_god_rays(e.target.checked);
                    saveSettings();
                });
                document.getElementById('fog-godray-intensity').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_volumetric_fog_god_ray_intensity) app.set_volumetric_fog_god_ray_intensity(val);
                    document.getElementById('fog-godray-intensity-val').textContent = val.toFixed(1);
                    saveSettings();
                });

                // IBL controls
                document.getElementById('ibl-diffuse').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_ibl_diffuse_intensity) app.set_ibl_diffuse_intensity(val);
                    document.getElementById('ibl-diffuse-val').textContent = val.toFixed(1);
                    saveSettings();
                });
                document.getElementById('ibl-specular').addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    if (app.set_ibl_specular_intensity) app.set_ibl_specular_intensity(val);
                    document.getElementById('ibl-specular-val').textContent = val.toFixed(1);
                    saveSettings();
                });
                document.getElementById('ibl-reset').addEventListener('click', () => {
                    document.getElementById('ibl-diffuse').value = 0.3;
                    document.getElementById('ibl-diffuse-val').textContent = '0.3';
                    document.getElementById('ibl-specular').value = 1.0;
                    document.getElementById('ibl-specular-val').textContent = '1.0';
                    if (app.set_ibl_diffuse_intensity) app.set_ibl_diffuse_intensity(0.3);
                    if (app.set_ibl_specular_intensity) app.set_ibl_specular_intensity(1.0);
                    saveSettings();
                });

                // ============ Scene Lights ============
                function setupLightControls(index) {
                    const prefix = `light${index}`;

                    document.getElementById(`${prefix}-enabled`).addEventListener('change', (e) => {
                        if (app.set_light_enabled) app.set_light_enabled(index, e.target.checked);
                        saveSettings();
                    });

                    document.getElementById(`${prefix}-intensity`).addEventListener('input', (e) => {
                        const val = parseFloat(e.target.value);
                        document.getElementById(`${prefix}-intensity-val`).textContent = val;
                        if (app.set_light_intensity) app.set_light_intensity(index, val);
                        saveSettings();
                    });

                    document.getElementById(`${prefix}-color`).addEventListener('input', (e) => {
                        const rgb = hexToRgb(e.target.value);
                        if (app.set_light_color) app.set_light_color(index, rgb.r, rgb.g, rgb.b);
                        saveSettings();
                    });

                    ['x', 'y', 'z'].forEach(axis => {
                        document.getElementById(`${prefix}-${axis}`).addEventListener('input', (e) => {
                            const val = parseFloat(e.target.value);
                            document.getElementById(`${prefix}-${axis}-val`).textContent = val;
                            const x = parseFloat(document.getElementById(`${prefix}-x`).value);
                            const y = parseFloat(document.getElementById(`${prefix}-y`).value);
                            const z = parseFloat(document.getElementById(`${prefix}-z`).value);
                            if (app.set_light_position) app.set_light_position(index, x, y, z);
                            saveSettings();
                        });
                    });
                }

                // Setup controls for all 4 lights
                for (let i = 0; i < 4; i++) {
                    setupLightControls(i);
                }

                // Light preset selector
                document.getElementById('light-preset').addEventListener('change', (e) => {
                    const preset = e.target.value;
                    if (preset === 'studio' && app.apply_car_studio_preset) {
                        app.apply_car_studio_preset();
                        updateLightUI([
                            { x: 5, y: 8, z: 5, intensity: 15, color: '#fffaf2', enabled: true },
                            { x: -5, y: 6, z: 3, intensity: 10, color: '#e6f2ff', enabled: true },
                            { x: 0, y: 4, z: -6, intensity: 8, color: '#ffffff', enabled: true },
                            { x: -3, y: 1, z: -3, intensity: 5, color: '#ccd9e6', enabled: true }
                        ]);
                    } else if (preset === 'outdoor' && app.apply_outdoor_preset) {
                        app.apply_outdoor_preset();
                        updateLightUI([
                            { x: 10, y: 20, z: 10, intensity: 25, color: '#fff2d9', enabled: true },
                            { x: -5, y: 5, z: 5, intensity: 5, color: '#b3ccff', enabled: true },
                            { x: 0, y: 2, z: 0, intensity: 3, color: '#998066', enabled: true },
                            { x: 0, y: 0, z: 0, intensity: 0, color: '#ffffff', enabled: false }
                        ]);
                    } else if (preset === 'dramatic' && app.apply_dramatic_preset) {
                        app.apply_dramatic_preset();
                        updateLightUI([
                            { x: 3, y: 5, z: 0, intensity: 20, color: '#ffe6cc', enabled: true },
                            { x: -8, y: 3, z: -2, intensity: 4, color: '#6680b3', enabled: true },
                            { x: -2, y: 6, z: -5, intensity: 12, color: '#ffffff', enabled: true },
                            { x: 0, y: 0, z: 0, intensity: 0, color: '#ffffff', enabled: false }
                        ]);
                    }
                    saveSettings();
                });

                function updateLightUI(lights) {
                    lights.forEach((light, i) => {
                        document.getElementById(`light${i}-enabled`).checked = light.enabled;
                        document.getElementById(`light${i}-intensity`).value = light.intensity;
                        document.getElementById(`light${i}-intensity-val`).textContent = light.intensity;
                        document.getElementById(`light${i}-color`).value = light.color;
                        document.getElementById(`light${i}-x`).value = light.x;
                        document.getElementById(`light${i}-x-val`).textContent = light.x;
                        document.getElementById(`light${i}-y`).value = light.y;
                        document.getElementById(`light${i}-y-val`).textContent = light.y;
                        document.getElementById(`light${i}-z`).value = light.z;
                        document.getElementById(`light${i}-z-val`).textContent = light.z;
                    });
                }

                // ============ LocalStorage Persistence ============
                const STORAGE_KEY = 'ren-engine-settings';

                function saveSettings() {
                    const settings = {
                        // Render mode
                        renderMode: document.getElementById('render-mode').value,
                        // Bloom
                        bloomEnabled: document.getElementById('bloom-enabled').checked,
                        bloomIntensity: document.getElementById('bloom-intensity').value,
                        bloomThreshold: document.getElementById('bloom-threshold').value,
                        exposure: document.getElementById('exposure').value,
                        // Vignette
                        vignetteEnabled: document.getElementById('vignette-enabled').checked,
                        vignetteIntensity: document.getElementById('vignette-intensity').value,
                        vignetteSmoothness: document.getElementById('vignette-smoothness').value,
                        vignetteRoundness: document.getElementById('vignette-roundness').value,
                        // Color Correction
                        ccEnabled: document.getElementById('cc-enabled').checked,
                        ccBrightness: document.getElementById('cc-brightness').value,
                        ccContrast: document.getElementById('cc-contrast').value,
                        ccSaturation: document.getElementById('cc-saturation').value,
                        ccGamma: document.getElementById('cc-gamma').value,
                        ccTemperature: document.getElementById('cc-temperature').value,
                        ccTint: document.getElementById('cc-tint').value,
                        // Hemisphere
                        hemisphereEnabled: document.getElementById('hemisphere-enabled').checked,
                        hemisphereSkyColor: document.getElementById('hemisphere-sky-color').value,
                        hemisphereGroundColor: document.getElementById('hemisphere-ground-color').value,
                        hemisphereIntensity: document.getElementById('hemisphere-intensity').value,
                        // Skybox
                        skyboxEnabled: document.getElementById('skybox-enabled').checked,
                        skyboxExposure: document.getElementById('skybox-exposure').value,
                        skyboxSkyColor: document.getElementById('skybox-sky-color').value,
                        skyboxHorizonColor: document.getElementById('skybox-horizon-color').value,
                        skyboxGroundColor: document.getElementById('skybox-ground-color').value,
                        // Shadows
                        shadowsEnabled: document.getElementById('shadows-enabled').checked,
                        shadowResolution: document.getElementById('shadow-resolution').value,
                        shadowPcf: document.getElementById('shadow-pcf').value,
                        shadowBias: document.getElementById('shadow-bias').value,
                        shadowNormalBias: document.getElementById('shadow-normal-bias').value,
                        // SSAO
                        ssaoEnabled: document.getElementById('ssao-enabled').checked,
                        ssaoQuality: document.getElementById('ssao-quality').value,
                        ssaoRadius: document.getElementById('ssao-radius').value,
                        ssaoIntensity: document.getElementById('ssao-intensity').value,
                        ssaoBias: document.getElementById('ssao-bias').value,
                        // GTAO
                        gtaoEnabled: document.getElementById('gtao-enabled').checked,
                        gtaoQuality: document.getElementById('gtao-quality').value,
                        gtaoRadius: document.getElementById('gtao-radius').value,
                        gtaoIntensity: document.getElementById('gtao-intensity').value,
                        gtaoPower: document.getElementById('gtao-power').value,
                        gtaoFalloff: document.getElementById('gtao-falloff').value,
                        // Lumen GI
                        lumenEnabled: document.getElementById('lumen-enabled').checked,
                        lumenQuality: document.getElementById('lumen-quality').value,
                        lumenIntensity: document.getElementById('lumen-intensity').value,
                        lumenDistance: document.getElementById('lumen-distance').value,
                        lumenThickness: document.getElementById('lumen-thickness').value,
                        // Volumetric Fog
                        fogEnabled: document.getElementById('fog-enabled').checked,
                        fogQuality: document.getElementById('fog-quality').value,
                        fogDensity: document.getElementById('fog-density').value,
                        fogDistance: document.getElementById('fog-distance').value,
                        fogHeight: document.getElementById('fog-height').value,
                        fogScattering: document.getElementById('fog-scattering').value,
                        fogGodrays: document.getElementById('fog-godrays').checked,
                        fogGodrayIntensity: document.getElementById('fog-godray-intensity').value,
                        // IBL
                        iblDiffuse: document.getElementById('ibl-diffuse').value,
                        iblSpecular: document.getElementById('ibl-specular').value,
                        // AA
                        aaMode: document.getElementById('aa-mode').value,
                        fxaaQuality: document.getElementById('fxaa-quality').value,
                        smaaQuality: document.getElementById('smaa-quality').value,
                        taaBlend: document.getElementById('taa-blend').value,
                        taaSharpness: document.getElementById('taa-sharpness').value,
                        // DoF
                        dofEnabled: document.getElementById('dof-enabled').checked,
                        dofQuality: document.getElementById('dof-quality').value,
                        dofFocalDistance: document.getElementById('dof-focal-distance').value,
                        dofFocalRange: document.getElementById('dof-focal-range').value,
                        dofBlurStrength: document.getElementById('dof-blur-strength').value,
                        dofHighlightBoost: document.getElementById('dof-highlight-boost').value,
                        dofHighlightThreshold: document.getElementById('dof-highlight-threshold').value,
                        // SSR
                        ssrEnabled: document.getElementById('ssr-enabled').checked,
                        ssrQuality: document.getElementById('ssr-quality').value,
                        ssrMaxDistance: document.getElementById('ssr-max-distance').value,
                        ssrThickness: document.getElementById('ssr-thickness').value,
                        ssrIntensity: document.getElementById('ssr-intensity').value,
                        // Motion Blur
                        motionBlurEnabled: document.getElementById('motion-blur-enabled').checked,
                        motionBlurQuality: document.getElementById('motion-blur-quality').value,
                        motionBlurIntensity: document.getElementById('motion-blur-intensity').value,
                        motionBlurMax: document.getElementById('motion-blur-max').value,
                        motionBlurVelocity: document.getElementById('motion-blur-velocity').value,
                        // Outline
                        outlineEnabled: document.getElementById('outline-enabled').checked,
                        outlineMode: document.getElementById('outline-mode').value,
                        outlineThickness: document.getElementById('outline-thickness').value,
                        outlineDepth: document.getElementById('outline-depth').value,
                        outlineNormal: document.getElementById('outline-normal').value,
                        outlineColor: document.getElementById('outline-color').value,
                        // Helpers
                        showGrid: document.getElementById('show-grid').checked,
                        showAxes: document.getElementById('show-axes').checked,
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
                }

                function loadSettings() {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (!saved) return;

                    try {
                        const s = JSON.parse(saved);

                        // Helper to set value and trigger update
                        const setVal = (id, val, valId) => {
                            const el = document.getElementById(id);
                            if (el && val !== undefined) {
                                if (el.type === 'checkbox') el.checked = val;
                                else el.value = val;
                                if (valId) document.getElementById(valId).textContent = parseFloat(val).toFixed(2);
                            }
                        };

                        // Apply saved settings to UI
                        setVal('render-mode', s.renderMode);
                        setVal('bloom-enabled', s.bloomEnabled);
                        setVal('bloom-intensity', s.bloomIntensity, 'bloom-intensity-val');
                        setVal('bloom-threshold', s.bloomThreshold, 'bloom-threshold-val');
                        setVal('exposure', s.exposure, 'exposure-val');
                        setVal('vignette-enabled', s.vignetteEnabled);
                        setVal('vignette-intensity', s.vignetteIntensity, 'vignette-intensity-val');
                        setVal('vignette-smoothness', s.vignetteSmoothness, 'vignette-smoothness-val');
                        setVal('vignette-roundness', s.vignetteRoundness, 'vignette-roundness-val');
                        setVal('cc-enabled', s.ccEnabled);
                        setVal('cc-brightness', s.ccBrightness, 'cc-brightness-val');
                        setVal('cc-contrast', s.ccContrast, 'cc-contrast-val');
                        setVal('cc-saturation', s.ccSaturation, 'cc-saturation-val');
                        setVal('cc-gamma', s.ccGamma, 'cc-gamma-val');
                        setVal('cc-temperature', s.ccTemperature, 'cc-temperature-val');
                        setVal('cc-tint', s.ccTint, 'cc-tint-val');
                        setVal('hemisphere-enabled', s.hemisphereEnabled);
                        setVal('hemisphere-sky-color', s.hemisphereSkyColor);
                        setVal('hemisphere-ground-color', s.hemisphereGroundColor);
                        setVal('hemisphere-intensity', s.hemisphereIntensity, 'hemisphere-intensity-val');
                        setVal('skybox-enabled', s.skyboxEnabled);
                        setVal('skybox-exposure', s.skyboxExposure, 'skybox-exposure-val');
                        setVal('skybox-sky-color', s.skyboxSkyColor);
                        setVal('skybox-horizon-color', s.skyboxHorizonColor);
                        setVal('skybox-ground-color', s.skyboxGroundColor);
                        setVal('shadows-enabled', s.shadowsEnabled);
                        setVal('shadow-resolution', s.shadowResolution);
                        setVal('shadow-pcf', s.shadowPcf);
                        setVal('shadow-bias', s.shadowBias, 'shadow-bias-val');
                        setVal('shadow-normal-bias', s.shadowNormalBias, 'shadow-normal-bias-val');
                        setVal('ssao-enabled', s.ssaoEnabled);
                        setVal('ssao-quality', s.ssaoQuality);
                        setVal('ssao-radius', s.ssaoRadius, 'ssao-radius-val');
                        setVal('ssao-intensity', s.ssaoIntensity, 'ssao-intensity-val');
                        setVal('ssao-bias', s.ssaoBias, 'ssao-bias-val');
                        setVal('gtao-enabled', s.gtaoEnabled);
                        setVal('gtao-quality', s.gtaoQuality);
                        setVal('gtao-radius', s.gtaoRadius, 'gtao-radius-val');
                        setVal('gtao-intensity', s.gtaoIntensity, 'gtao-intensity-val');
                        setVal('gtao-power', s.gtaoPower, 'gtao-power-val');
                        setVal('gtao-falloff', s.gtaoFalloff, 'gtao-falloff-val');
                        setVal('lumen-enabled', s.lumenEnabled);
                        setVal('lumen-quality', s.lumenQuality);
                        setVal('lumen-intensity', s.lumenIntensity, 'lumen-intensity-val');
                        setVal('lumen-distance', s.lumenDistance, 'lumen-distance-val');
                        setVal('lumen-thickness', s.lumenThickness, 'lumen-thickness-val');
                        setVal('fog-enabled', s.fogEnabled);
                        setVal('fog-quality', s.fogQuality);
                        setVal('fog-density', s.fogDensity, 'fog-density-val');
                        setVal('fog-distance', s.fogDistance, 'fog-distance-val');
                        setVal('fog-height', s.fogHeight, 'fog-height-val');
                        setVal('fog-scattering', s.fogScattering, 'fog-scattering-val');
                        setVal('fog-godrays', s.fogGodrays);
                        setVal('fog-godray-intensity', s.fogGodrayIntensity, 'fog-godray-intensity-val');
                        setVal('ibl-diffuse', s.iblDiffuse, 'ibl-diffuse-val');
                        setVal('ibl-specular', s.iblSpecular, 'ibl-specular-val');
                        setVal('aa-mode', s.aaMode);
                        setVal('fxaa-quality', s.fxaaQuality);
                        setVal('smaa-quality', s.smaaQuality);
                        setVal('taa-blend', s.taaBlend, 'taa-blend-val');
                        setVal('taa-sharpness', s.taaSharpness, 'taa-sharpness-val');
                        setVal('dof-enabled', s.dofEnabled);
                        setVal('dof-quality', s.dofQuality);
                        setVal('dof-focal-distance', s.dofFocalDistance, 'dof-focal-distance-val');
                        setVal('dof-focal-range', s.dofFocalRange, 'dof-focal-range-val');
                        setVal('dof-blur-strength', s.dofBlurStrength, 'dof-blur-strength-val');
                        setVal('dof-highlight-boost', s.dofHighlightBoost, 'dof-highlight-boost-val');
                        setVal('dof-highlight-threshold', s.dofHighlightThreshold, 'dof-highlight-threshold-val');
                        setVal('ssr-enabled', s.ssrEnabled);
                        setVal('ssr-quality', s.ssrQuality);
                        setVal('ssr-max-distance', s.ssrMaxDistance, 'ssr-max-distance-val');
                        setVal('ssr-thickness', s.ssrThickness, 'ssr-thickness-val');
                        setVal('ssr-intensity', s.ssrIntensity, 'ssr-intensity-val');
                        setVal('motion-blur-enabled', s.motionBlurEnabled);
                        setVal('motion-blur-quality', s.motionBlurQuality);
                        setVal('motion-blur-intensity', s.motionBlurIntensity, 'motion-blur-intensity-val');
                        setVal('motion-blur-max', s.motionBlurMax, 'motion-blur-max-val');
                        setVal('motion-blur-velocity', s.motionBlurVelocity, 'motion-blur-velocity-val');
                        setVal('outline-enabled', s.outlineEnabled);
                        setVal('outline-mode', s.outlineMode);
                        setVal('outline-thickness', s.outlineThickness, 'outline-thickness-val');
                        setVal('outline-depth', s.outlineDepth, 'outline-depth-val');
                        setVal('outline-normal', s.outlineNormal, 'outline-normal-val');
                        setVal('outline-color', s.outlineColor);
                        setVal('show-grid', s.showGrid);
                        setVal('show-axes', s.showAxes);

                        console.log('Loaded settings from localStorage');
                    } catch (e) {
                        console.warn('Failed to load settings:', e);
                    }
                }

                function applySettingsToApp() {
                    // Apply all current UI values to the app
                    app.set_render_mode(parseInt(document.getElementById('render-mode').value));
                    app.set_bloom_enabled(document.getElementById('bloom-enabled').checked);
                    app.set_bloom_intensity(parseFloat(document.getElementById('bloom-intensity').value));
                    app.set_bloom_threshold(parseFloat(document.getElementById('bloom-threshold').value));
                    app.set_exposure(parseFloat(document.getElementById('exposure').value));
                    app.set_vignette_enabled(document.getElementById('vignette-enabled').checked);
                    app.set_vignette_intensity(parseFloat(document.getElementById('vignette-intensity').value));
                    app.set_vignette_smoothness(parseFloat(document.getElementById('vignette-smoothness').value));
                    app.set_vignette_roundness(parseFloat(document.getElementById('vignette-roundness').value));
                    app.set_color_correction_enabled(document.getElementById('cc-enabled').checked);
                    app.set_cc_brightness(parseFloat(document.getElementById('cc-brightness').value));
                    app.set_cc_contrast(parseFloat(document.getElementById('cc-contrast').value));
                    app.set_cc_saturation(parseFloat(document.getElementById('cc-saturation').value));
                    app.set_cc_gamma(parseFloat(document.getElementById('cc-gamma').value));
                    app.set_cc_temperature(parseFloat(document.getElementById('cc-temperature').value));
                    app.set_cc_tint(parseFloat(document.getElementById('cc-tint').value));
                    app.set_hemisphere_light_enabled(document.getElementById('hemisphere-enabled').checked);
                    app.set_hemisphere_intensity(parseFloat(document.getElementById('hemisphere-intensity').value));
                    app.set_skybox_enabled(document.getElementById('skybox-enabled').checked);
                    app.set_skybox_exposure(parseFloat(document.getElementById('skybox-exposure').value));
                    if (app.set_shadows_enabled) app.set_shadows_enabled(document.getElementById('shadows-enabled').checked);
                    app.set_ssao_enabled(document.getElementById('ssao-enabled').checked);
                    app.set_ssao_quality(parseInt(document.getElementById('ssao-quality').value));
                    app.set_ssao_radius(parseFloat(document.getElementById('ssao-radius').value));
                    app.set_ssao_intensity(parseFloat(document.getElementById('ssao-intensity').value));
                    if (app.set_ssao_bias) app.set_ssao_bias(parseFloat(document.getElementById('ssao-bias').value));
                    if (app.set_gtao_enabled) app.set_gtao_enabled(document.getElementById('gtao-enabled').checked);
                    if (app.set_gtao_quality) app.set_gtao_quality(parseInt(document.getElementById('gtao-quality').value));
                    if (app.set_gtao_radius) app.set_gtao_radius(parseFloat(document.getElementById('gtao-radius').value));
                    if (app.set_gtao_intensity) app.set_gtao_intensity(parseFloat(document.getElementById('gtao-intensity').value));
                    if (app.set_gtao_power) app.set_gtao_power(parseFloat(document.getElementById('gtao-power').value));
                    if (app.set_gtao_falloff) app.set_gtao_falloff(parseFloat(document.getElementById('gtao-falloff').value));
                    if (app.set_lumen_enabled) app.set_lumen_enabled(document.getElementById('lumen-enabled').checked);
                    if (app.set_lumen_quality) app.set_lumen_quality(parseInt(document.getElementById('lumen-quality').value));
                    if (app.set_lumen_intensity) app.set_lumen_intensity(parseFloat(document.getElementById('lumen-intensity').value));
                    if (app.set_lumen_max_distance) app.set_lumen_max_distance(parseFloat(document.getElementById('lumen-distance').value));
                    if (app.set_lumen_thickness) app.set_lumen_thickness(parseFloat(document.getElementById('lumen-thickness').value));
                    if (app.set_volumetric_fog_enabled) app.set_volumetric_fog_enabled(document.getElementById('fog-enabled').checked);
                    if (app.set_volumetric_fog_quality) app.set_volumetric_fog_quality(parseInt(document.getElementById('fog-quality').value));
                    if (app.set_volumetric_fog_density) app.set_volumetric_fog_density(parseFloat(document.getElementById('fog-density').value));
                    if (app.set_volumetric_fog_max_distance) app.set_volumetric_fog_max_distance(parseFloat(document.getElementById('fog-distance').value));
                    if (app.set_volumetric_fog_height_falloff) app.set_volumetric_fog_height_falloff(parseFloat(document.getElementById('fog-height').value));
                    if (app.set_volumetric_fog_scattering) app.set_volumetric_fog_scattering(parseFloat(document.getElementById('fog-scattering').value));
                    if (app.set_volumetric_fog_god_rays) app.set_volumetric_fog_god_rays(document.getElementById('fog-godrays').checked);
                    if (app.set_volumetric_fog_god_ray_intensity) app.set_volumetric_fog_god_ray_intensity(parseFloat(document.getElementById('fog-godray-intensity').value));
                    if (app.set_ibl_diffuse_intensity) app.set_ibl_diffuse_intensity(parseFloat(document.getElementById('ibl-diffuse').value));
                    if (app.set_ibl_specular_intensity) app.set_ibl_specular_intensity(parseFloat(document.getElementById('ibl-specular').value));
                    app.set_aa_mode(parseInt(document.getElementById('aa-mode').value));
                    app.set_fxaa_quality(parseInt(document.getElementById('fxaa-quality').value));
                    app.set_smaa_quality(parseInt(document.getElementById('smaa-quality').value));
                    app.set_taa_blend_factor(parseFloat(document.getElementById('taa-blend').value));
                    app.set_taa_sharpness(parseFloat(document.getElementById('taa-sharpness').value));
                    app.set_dof_enabled(document.getElementById('dof-enabled').checked);
                    app.set_dof_quality(parseInt(document.getElementById('dof-quality').value));
                    app.set_dof_focal_distance(parseFloat(document.getElementById('dof-focal-distance').value));
                    app.set_dof_focal_range(parseFloat(document.getElementById('dof-focal-range').value));
                    app.set_dof_blur_strength(parseFloat(document.getElementById('dof-blur-strength').value));
                    if (app.set_dof_highlight_boost) app.set_dof_highlight_boost(parseFloat(document.getElementById('dof-highlight-boost').value));
                    if (app.set_dof_highlight_threshold) app.set_dof_highlight_threshold(parseFloat(document.getElementById('dof-highlight-threshold').value));
                    app.set_ssr_enabled(document.getElementById('ssr-enabled').checked);
                    app.set_ssr_quality(parseInt(document.getElementById('ssr-quality').value));
                    app.set_ssr_max_distance(parseFloat(document.getElementById('ssr-max-distance').value));
                    app.set_ssr_thickness(parseFloat(document.getElementById('ssr-thickness').value));
                    app.set_ssr_intensity(parseFloat(document.getElementById('ssr-intensity').value));
                    app.set_motion_blur_enabled(document.getElementById('motion-blur-enabled').checked);
                    app.set_motion_blur_quality(parseInt(document.getElementById('motion-blur-quality').value));
                    app.set_motion_blur_intensity(parseFloat(document.getElementById('motion-blur-intensity').value));
                    app.set_motion_blur_max(parseFloat(document.getElementById('motion-blur-max').value));
                    app.set_motion_blur_velocity_scale(parseFloat(document.getElementById('motion-blur-velocity').value));
                    app.set_outline_enabled(document.getElementById('outline-enabled').checked);
                    app.set_outline_mode(parseInt(document.getElementById('outline-mode').value));
                    app.set_outline_thickness(parseFloat(document.getElementById('outline-thickness').value));
                    app.set_outline_depth_threshold(parseFloat(document.getElementById('outline-depth').value));
                    app.set_outline_normal_threshold(parseFloat(document.getElementById('outline-normal').value));
                    app.set_grid_visible(document.getElementById('show-grid').checked);
                    app.set_axes_visible(document.getElementById('show-axes').checked);
                    updateAAOptions();
                    updateSkyColors();
                }

                // Load settings from localStorage and apply
                loadSettings();
                applySettingsToApp();

                // Add save on change to all inputs
                document.querySelectorAll('#panel input, #panel select').forEach(el => {
                    el.addEventListener('change', saveSettings);
                    el.addEventListener('input', saveSettings);
                });

                // Initialize shadow settings from default checkbox values
                if (app.set_shadows_enabled) {
                    const shadowsEnabled = document.getElementById('shadows-enabled').checked;
                    app.set_shadows_enabled(shadowsEnabled);
                }

            } catch (err) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = err.message || String(err);
                console.error('Ren Engine initialization failed:', err);
            }
        }

        init();
    </script>
</body>
</html>
