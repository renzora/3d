<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ren - WebGPU 3D Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.19/dist/lil-gui.umd.min.js"></script>
    <style>
        html, body, canvas, div#loading, div#error, div#stats, div#controls {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-family: system-ui, sans-serif;
            font-size: 18px;
        }
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #f44;
            font-family: system-ui, sans-serif;
            font-size: 16px;
            max-width: 600px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            display: none;
        }
        #stats {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            font-family: monospace;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 4px;
            z-index: 100;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            margin-top: 120px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        #controls button, #controls label {
            background: rgba(60, 120, 200, 0.8);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: system-ui, sans-serif;
            font-size: 13px;
        }
        #controls button:hover, #controls label:hover {
            background: rgba(80, 140, 220, 0.9);
        }
        #controls input[type="file"] {
            display: none;
        }
        .lil-gui.root {
            z-index: 1000 !important;
            top: 0 !important;
            right: 0 !important;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="loading">Loading Ren Engine...</div>
    <div id="error"></div>
    <div id="stats"></div>
    <div id="controls">
        <label for="model-input">Load Model</label>
        <input type="file" id="model-input" accept=".glb,.gltf,.obj">
        <label for="nanite-input" style="background: rgba(200, 80, 60, 0.8);">Load as Nanite</label>
        <input type="file" id="nanite-input" accept=".glb,.gltf">
        <button id="nanite-demo-btn" style="background: rgba(200, 80, 60, 0.8);">Nanite Demo Cube</button>
        <button id="clear-btn">Clear Models</button>
        <button id="demo-btn">Add Demo</button>
    </div>

    <script type="module">
        async function init() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const statsEl = document.getElementById('stats');
            const canvas = document.getElementById('canvas');

            try {
                if (!navigator.gpu) {
                    throw new Error('WebGPU is not supported in your browser.');
                }

                const adapter = await navigator.gpu.requestAdapter();
                if (!adapter) {
                    throw new Error('Failed to get WebGPU adapter.');
                }

                const { default: init, RenApp } = await import('./pkg/ren.js');
                await init();

                loadingEl.style.display = 'none';

                const app = await RenApp.new('canvas');

                const STORAGE_KEY = 'ren-engine-settings';

                // Default settings
                const defaultSettings = {
                    // Camera
                    cameraFov: 60,
                    cameraNear: 0.1,
                    cameraFar: 1000,
                    cameraMoveSpeed: 1.0,
                    cameraRotateSensitivity: 1.0,
                    cameraZoomSpeed: 1.0,
                    // Render
                    renderMode: 0,
                    // Day/Night
                    dayNightEnabled: false,
                    dayNightSpeed: 1.0,
                    dayNightTime: 0.5,
                    // Bloom
                    bloomEnabled: true,
                    bloomIntensity: 0.3,
                    bloomThreshold: 0.85,
                    // Tonemapping
                    tonemapMode: 3,
                    exposure: 1.2,
                    // Auto Exposure
                    autoExposureEnabled: true,
                    autoExposureCompensation: 0.0,
                    autoExposureSpeedUp: 3.0,
                    autoExposureSpeedDown: 1.0,
                    // Vignette
                    vignetteEnabled: true,
                    vignetteIntensity: 0.15,
                    vignetteSmoothness: 0.7,
                    vignetteRoundness: 0.8,
                    // Color Correction
                    ccEnabled: true,
                    ccBrightness: 0,
                    ccContrast: 1.05,
                    ccSaturation: 1.05,
                    ccGamma: 1.0,
                    ccTemperature: 0,
                    ccTint: 0,
                    // Hemisphere
                    hemisphereEnabled: true,
                    hemisphereSkyColor: '#b4d4f0',
                    hemisphereGroundColor: '#4a3d2d',
                    hemisphereIntensity: 0.4,
                    // Skybox
                    skyboxEnabled: true,
                    skyboxExposure: 1.0,
                    skyboxSkyColor: '#6496e6',
                    skyboxHorizonColor: '#c8d2dc',
                    skyboxGroundColor: '#322d28',
                    // Procedural Sky
                    proceduralSkyEnabled: false,
                    proceduralSkyAzimuth: 180,
                    proceduralSkyElevation: 45,
                    proceduralSkySunIntensity: 22,
                    proceduralSkyTurbidity: 2.0,
                    proceduralSkyRayleigh: 1.0,
                    proceduralSkyMie: 1.0,
                    proceduralSkyMieG: 0.8,
                    proceduralSkyExposure: 1.0,
                    proceduralSkyCloudSpeed: 0.02,
                    // Shadows
                    shadowsEnabled: true,
                    shadowResolution: 2048,
                    shadowPcfMode: 5,
                    shadowBias: 0.003,
                    shadowNormalBias: 0.015,
                    pcssLightSize: 1.0,
                    pcssMaxRadius: 15,
                    contactShadowsEnabled: true,
                    contactShadowDistance: 1.0,
                    contactShadowThickness: 0.1,
                    contactShadowIntensity: 0.8,
                    shadowCascades: 4,
                    shadowLightType: 0,
                    // Material
                    clearCoat: 0,
                    clearCoatRoughness: 0.03,
                    sheen: 0,
                    sheenColor: '#ffffff',
                    baseMetallic: 0,
                    baseRoughness: 0.4,
                    // DoF
                    dofEnabled: false,
                    dofQuality: 1,
                    dofFocalDistance: 5.0,
                    dofFocalRange: 2.0,
                    dofAperture: 2.8,
                    dofBlurStrength: 1.0,
                    dofHighlightBoost: 0.5,
                    dofHighlightThreshold: 0.5,
                    // SSR
                    ssrEnabled: true,
                    ssrQuality: 2,
                    ssrMaxDistance: 30,
                    ssrThickness: 0.15,
                    ssrIntensity: 0.8,
                    // Motion Blur
                    motionBlurEnabled: false,
                    motionBlurQuality: 1,
                    motionBlurIntensity: 1.0,
                    motionBlurMax: 32,
                    motionBlurVelocity: 1.0,
                    // Outline
                    outlineEnabled: false,
                    outlineMode: 2,
                    outlineThickness: 1.0,
                    outlineDepthThreshold: 0.1,
                    outlineNormalThreshold: 0.5,
                    outlineColor: '#000000',
                    // AA
                    aaMode: 3,
                    fxaaQuality: 2,
                    smaaQuality: 2,
                    taaBlend: 0.92,
                    taaSharpness: 0.3,
                    // SSAO
                    ssaoEnabled: false,
                    ssaoQuality: 2,
                    ssaoRadius: 0.4,
                    ssaoIntensity: 1.2,
                    ssaoBias: 0.02,
                    // GTAO
                    gtaoEnabled: true,
                    gtaoQuality: 2,
                    gtaoRadius: 0.4,
                    gtaoIntensity: 1.2,
                    gtaoPower: 1.2,
                    gtaoFalloff: 0.15,
                    // Lumen GI
                    lumenEnabled: true,
                    lumenQuality: 2,
                    lumenIntensity: 0.8,
                    lumenDistance: 8.0,
                    lumenThickness: 0.15,
                    // Fog
                    fogEnabled: false,
                    fogQuality: 1,
                    fogDensity: 0.02,
                    fogDistance: 100,
                    fogHeight: 0.1,
                    fogScattering: 0.7,
                    fogGodrays: true,
                    fogGodrayIntensity: 1.0,
                    // Particles
                    particleGravity: true,
                    particleTurbulence: false,
                    // IBL
                    iblDiffuse: 0.3,
                    iblSpecular: 1.0,
                    // Detail
                    detailEnabled: false,
                    detailScale: 10,
                    detailIntensity: 0.3,
                    detailMaxDistance: 5,
                    detailAlbedoEnabled: false,
                    detailAlbedoScale: 10,
                    detailAlbedoIntensity: 0.3,
                    detailAlbedoBlendMode: 0,
                    // Helpers
                    showGrid: true,
                    showAxes: true,
                    // Gizmo
                    gizmoEnabled: false,
                    gizmoMode: 0,
                    gizmoTarget: -1,
                    // Lights
                    lightPreset: 'studio',
                };

                // Load saved settings from localStorage
                function loadSettings() {
                    try {
                        const saved = localStorage.getItem(STORAGE_KEY);
                        if (saved) {
                            const parsed = JSON.parse(saved);
                            // Merge and ensure types match defaults
                            const result = { ...defaultSettings };
                            for (const key in parsed) {
                                if (key in defaultSettings) {
                                    const defaultVal = defaultSettings[key];
                                    const savedVal = parsed[key];
                                    // Ensure types are preserved for dat.gui sliders
                                    if (typeof defaultVal === 'number') {
                                        result[key] = Number(savedVal);
                                    } else if (typeof defaultVal === 'boolean') {
                                        result[key] = !!savedVal;
                                    } else {
                                        result[key] = savedVal;
                                    }
                                }
                            }
                            return result;
                        }
                    } catch (e) {
                        console.warn('Failed to load settings:', e);
                    }
                    return { ...defaultSettings };
                }

                // Save settings to localStorage
                function saveSettings() {
                    try {
                        // Filter out function properties
                        const toSave = {};
                        for (const key in settings) {
                            if (typeof settings[key] !== 'function') {
                                toSave[key] = settings[key];
                            }
                        }
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
                    } catch (e) {
                        console.warn('Failed to save settings:', e);
                    }
                }

                // Initialize settings from localStorage or defaults
                const settings = loadSettings();

                // Add function properties (these can't be saved)
                settings.resetCC = function() {
                    settings.ccBrightness = 0;
                    settings.ccContrast = 1.0;
                    settings.ccSaturation = 1.0;
                    settings.ccGamma = 1.0;
                    settings.ccTemperature = 0;
                    settings.ccTint = 0;
                    app.reset_color_correction();
                    gui.updateDisplay();
                    saveSettings();
                };
                settings.spawnFire = function() { createParticleEffect('fire'); };
                settings.spawnSmoke = function() { createParticleEffect('smoke'); };
                settings.spawnSparks = function() { createParticleEffect('sparks'); };
                settings.spawnMagic = function() { createParticleEffect('magic'); };
                settings.spawnDebris = function() {
                    if (!app.create_particle_system) return;
                    const id = app.create_particle_system('debris');
                    app.set_particle_position(id, 0, 2, 0);
                    app.add_particle_gravity(id, 9.81);
                    app.particle_burst(id, 50);
                };
                settings.clearParticles = function() {
                    if (app.clear_particle_systems) app.clear_particle_systems();
                };
                settings.resetIBL = function() {
                    settings.iblDiffuse = 0.3;
                    settings.iblSpecular = 1.0;
                    if (app.set_ibl_diffuse_intensity) app.set_ibl_diffuse_intensity(0.3);
                    if (app.set_ibl_specular_intensity) app.set_ibl_specular_intensity(1.0);
                    gui.updateDisplay();
                    saveSettings();
                };

                // Create lil-gui
                const gui = new lil.GUI({ width: 300 });

                // Render Mode
                const renderFolder = gui.addFolder('Render Mode');
                const renderModes = { Lit: 0, Unlit: 1, Normals: 2, Depth: 3, Metallic: 4, Roughness: 5, AO: 6, UVs: 7, Flat: 8, Wireframe: 9 };
                renderFolder.add(settings, 'renderMode', renderModes).name('Mode').onChange(v => app.set_render_mode(v));

                // Camera
                const cameraFolder = gui.addFolder('Camera');
                cameraFolder.add(settings, 'cameraFov', 10, 120).name('Field of View').onChange(v => app.set_camera_fov(v));
                cameraFolder.add(settings, 'cameraNear', 0.01, 10).name('Near Plane').onChange(v => app.set_camera_near(v));
                cameraFolder.add(settings, 'cameraFar', 100, 10000).name('Far Plane').onChange(v => app.set_camera_far(v));
                cameraFolder.add(settings, 'cameraMoveSpeed', 0.1, 10).name('Move Speed').onChange(v => app.set_camera_move_speed(v));
                cameraFolder.add(settings, 'cameraRotateSensitivity', 0.1, 5).name('Rotate Sensitivity').onChange(v => app.set_camera_rotate_sensitivity(v));
                cameraFolder.add(settings, 'cameraZoomSpeed', 0.1, 5).name('Zoom Speed').onChange(v => app.set_camera_zoom_speed(v));

                // Day/Night
                const dayNightFolder = gui.addFolder('Day/Night Cycle');
                dayNightFolder.add(settings, 'dayNightEnabled').name('Auto Cycle');
                dayNightFolder.add(settings, 'dayNightSpeed', 0.1, 5).name('Speed');
                dayNightFolder.add(settings, 'dayNightTime', 0, 1).name('Time of Day').listen().onChange(v => updateSunFromTime(v));

                // Bloom
                const bloomFolder = gui.addFolder('Bloom');
                bloomFolder.add(settings, 'bloomEnabled').name('Enable').onChange(v => app.set_bloom_enabled(v));
                bloomFolder.add(settings, 'bloomIntensity', 0, 2).name('Intensity').onChange(v => app.set_bloom_intensity(v));
                bloomFolder.add(settings, 'bloomThreshold', 0, 1).name('Threshold').onChange(v => app.set_bloom_threshold(v));

                // Tonemapping
                const tonemapFolder = gui.addFolder('Tonemapping');
                const tonemapModes = { Linear: 0, Reinhard: 1, 'Reinhard Lum': 2, ACES: 3, 'Uncharted 2': 4, AgX: 5 };
                tonemapFolder.add(settings, 'tonemapMode', tonemapModes).name('Operator').onChange(v => app.set_tonemapping_mode(v));
                tonemapFolder.add(settings, 'exposure', 0.5, 3).name('Exposure').onChange(v => app.set_exposure(v));

                // Auto Exposure
                const autoExpFolder = gui.addFolder('Auto Exposure');
                autoExpFolder.add(settings, 'autoExposureEnabled').name('Eye Adaptation').onChange(v => app.set_auto_exposure_enabled(v));
                autoExpFolder.add(settings, 'autoExposureCompensation', -2, 2).name('Compensation').onChange(v => app.set_auto_exposure_compensation(v));
                autoExpFolder.add(settings, 'autoExposureSpeedUp', 0.5, 10).name('Speed Up').onChange(v => app.set_auto_exposure_speed_up(v));
                autoExpFolder.add(settings, 'autoExposureSpeedDown', 0.5, 5).name('Speed Down').onChange(v => app.set_auto_exposure_speed_down(v));

                // Vignette
                const vignetteFolder = gui.addFolder('Vignette');
                vignetteFolder.add(settings, 'vignetteEnabled').name('Enable').onChange(v => app.set_vignette_enabled(v));
                vignetteFolder.add(settings, 'vignetteIntensity', 0, 1).name('Intensity').onChange(v => app.set_vignette_intensity(v));
                vignetteFolder.add(settings, 'vignetteSmoothness', 0.1, 1.5).name('Smoothness').onChange(v => app.set_vignette_smoothness(v));
                vignetteFolder.add(settings, 'vignetteRoundness', 0, 1).name('Roundness').onChange(v => app.set_vignette_roundness(v));

                // Color Correction
                const ccFolder = gui.addFolder('Color Correction');
                ccFolder.add(settings, 'ccEnabled').name('Enable').onChange(v => app.set_color_correction_enabled(v));
                ccFolder.add(settings, 'ccBrightness', -1, 1).name('Brightness').onChange(v => app.set_cc_brightness(v));
                ccFolder.add(settings, 'ccContrast', 0, 2).name('Contrast').onChange(v => app.set_cc_contrast(v));
                ccFolder.add(settings, 'ccSaturation', 0, 2).name('Saturation').onChange(v => app.set_cc_saturation(v));
                ccFolder.add(settings, 'ccGamma', 0.5, 2.5).name('Gamma').onChange(v => app.set_cc_gamma(v));
                ccFolder.add(settings, 'ccTemperature', -1, 1).name('Temperature').onChange(v => app.set_cc_temperature(v));
                ccFolder.add(settings, 'ccTint', -1, 1).name('Tint').onChange(v => app.set_cc_tint(v));
                ccFolder.add(settings, 'resetCC').name('Reset');

                // Hemisphere Light
                const hemiFolder = gui.addFolder('Hemisphere Light');
                hemiFolder.add(settings, 'hemisphereEnabled').name('Enable').onChange(v => app.set_hemisphere_light_enabled(v));
                hemiFolder.addColor(settings, 'hemisphereSkyColor').name('Sky Color').onChange(v => {
                    const rgb = hexToRgb(v);
                    app.set_hemisphere_sky_color(rgb.r, rgb.g, rgb.b);
                });
                hemiFolder.addColor(settings, 'hemisphereGroundColor').name('Ground Color').onChange(v => {
                    const rgb = hexToRgb(v);
                    app.set_hemisphere_ground_color(rgb.r, rgb.g, rgb.b);
                });
                hemiFolder.add(settings, 'hemisphereIntensity', 0, 2).name('Intensity').onChange(v => app.set_hemisphere_intensity(v));

                // Skybox
                const skyboxFolder = gui.addFolder('Skybox');
                skyboxFolder.add(settings, 'skyboxEnabled').name('Enable').onChange(v => app.set_skybox_enabled(v));
                skyboxFolder.add(settings, 'skyboxExposure', 0.1, 3).name('Exposure').onChange(v => app.set_skybox_exposure(v));
                skyboxFolder.addColor(settings, 'skyboxSkyColor').name('Sky Color').onChange(updateSkyColors);
                skyboxFolder.addColor(settings, 'skyboxHorizonColor').name('Horizon Color').onChange(updateSkyColors);
                skyboxFolder.addColor(settings, 'skyboxGroundColor').name('Ground Color').onChange(updateSkyColors);

                // Procedural Sky
                const procSkyFolder = gui.addFolder('Procedural Sky');
                procSkyFolder.add(settings, 'proceduralSkyEnabled').name('Enable').onChange(v => {
                    app.set_procedural_sky_enabled(v);
                    if (v) updateSunFromTime(settings.dayNightTime);
                });
                procSkyFolder.add(settings, 'proceduralSkyAzimuth', 0, 360).name('Sun Azimuth').onChange(v => updateProceduralSkySun());
                procSkyFolder.add(settings, 'proceduralSkyElevation', -10, 90).name('Sun Elevation').onChange(v => updateProceduralSkySun());
                procSkyFolder.add(settings, 'proceduralSkySunIntensity', 1, 50).name('Sun Intensity').onChange(v => app.set_procedural_sky_sun_intensity(v));
                procSkyFolder.add(settings, 'proceduralSkyTurbidity', 1, 10).name('Turbidity').onChange(v => app.set_procedural_sky_turbidity(v));
                procSkyFolder.add(settings, 'proceduralSkyRayleigh', 0, 4).name('Rayleigh').onChange(v => app.set_procedural_sky_rayleigh(v));
                procSkyFolder.add(settings, 'proceduralSkyMie', 0, 4).name('Mie').onChange(v => app.set_procedural_sky_mie(v));
                procSkyFolder.add(settings, 'proceduralSkyMieG', 0, 0.999).name('Mie Direction').onChange(v => app.set_procedural_sky_mie_directional(v));
                procSkyFolder.add(settings, 'proceduralSkyExposure', 0.1, 3).name('Exposure').onChange(v => app.set_procedural_sky_exposure(v));
                procSkyFolder.add(settings, 'proceduralSkyCloudSpeed', 0, 0.1).name('Cloud Speed').onChange(v => app.set_procedural_sky_cloud_speed(v));

                // Shadows
                const shadowFolder = gui.addFolder('Shadows');
                shadowFolder.add(settings, 'shadowsEnabled').name('Enable').onChange(v => { if (app.set_shadows_enabled) app.set_shadows_enabled(v); });
                shadowFolder.add(settings, 'shadowResolution', { '512': 512, '1024': 1024, '2048': 2048, '4096': 4096 }).name('Resolution').onChange(v => { if (app.set_shadow_resolution) app.set_shadow_resolution(parseInt(v)); });
                shadowFolder.add(settings, 'shadowPcfMode', { None: 0, '2x2': 1, '3x3': 2, '5x5': 3, Poisson: 4, 'PCSS (Soft)': 5 }).name('PCF Mode').onChange(v => { if (app.set_shadow_pcf_mode) app.set_shadow_pcf_mode(parseInt(v)); });
                shadowFolder.add(settings, 'shadowBias', 0.001, 0.02).name('Bias').onChange(v => { if (app.set_shadow_bias) app.set_shadow_bias(v); });
                shadowFolder.add(settings, 'shadowNormalBias', 0, 0.1).name('Normal Bias').onChange(v => { if (app.set_shadow_normal_bias) app.set_shadow_normal_bias(v); });
                shadowFolder.add(settings, 'pcssLightSize', 0.1, 5).name('PCSS Light Size').onChange(v => { if (app.set_pcss_light_size) app.set_pcss_light_size(v); });
                shadowFolder.add(settings, 'pcssMaxRadius', 1, 30).name('PCSS Max Radius').onChange(v => { if (app.set_pcss_max_filter_radius) app.set_pcss_max_filter_radius(v); });
                shadowFolder.add(settings, 'contactShadowsEnabled').name('Contact Shadows').onChange(v => { if (app.set_contact_shadows_enabled) app.set_contact_shadows_enabled(v); });
                shadowFolder.add(settings, 'contactShadowDistance', 0.1, 5).name('Contact Distance').onChange(v => { if (app.set_contact_shadow_distance) app.set_contact_shadow_distance(v); });
                shadowFolder.add(settings, 'contactShadowThickness', 0.01, 1).name('Contact Thickness').onChange(v => { if (app.set_contact_shadow_thickness) app.set_contact_shadow_thickness(v); });
                shadowFolder.add(settings, 'contactShadowIntensity', 0, 1).name('Contact Intensity').onChange(v => { if (app.set_contact_shadow_intensity) app.set_contact_shadow_intensity(v); });
                shadowFolder.add(settings, 'shadowCascades', { '1': 1, '2': 2, '3': 3, '4': 4 }).name('Cascades').onChange(v => { if (app.set_shadow_cascades) app.set_shadow_cascades(parseInt(v)); });

                // Material
                const materialFolder = gui.addFolder('Material');
                materialFolder.add(settings, 'clearCoat', 0, 1).name('Clear Coat').onChange(v => { if (app.set_clear_coat) app.set_clear_coat(v); });
                materialFolder.add(settings, 'clearCoatRoughness', 0, 0.5).name('CC Roughness').onChange(v => { if (app.set_clear_coat_roughness) app.set_clear_coat_roughness(v); });
                materialFolder.add(settings, 'sheen', 0, 1).name('Sheen').onChange(v => { if (app.set_sheen) app.set_sheen(v); });
                materialFolder.addColor(settings, 'sheenColor').name('Sheen Color').onChange(v => {
                    const rgb = hexToRgb(v);
                    if (app.set_sheen_color) app.set_sheen_color(rgb.r, rgb.g, rgb.b);
                });
                materialFolder.add(settings, 'baseMetallic', 0, 1).name('Metallic').onChange(v => { if (app.set_material_metallic) app.set_material_metallic(v); });
                materialFolder.add(settings, 'baseRoughness', 0.04, 1).name('Roughness').onChange(v => { if (app.set_material_roughness) app.set_material_roughness(v); });

                // Depth of Field
                const dofFolder = gui.addFolder('Depth of Field');
                dofFolder.add(settings, 'dofEnabled').name('Enable').onChange(v => app.set_dof_enabled(v));
                dofFolder.add(settings, 'dofQuality', { Low: 0, Medium: 1, High: 2, Ultra: 3 }).name('Quality').onChange(v => app.set_dof_quality(parseInt(v)));
                dofFolder.add(settings, 'dofFocalDistance', 1, 20).name('Focal Distance').onChange(v => app.set_dof_focal_distance(v));
                dofFolder.add(settings, 'dofFocalRange', 0.5, 10).name('Focal Range').onChange(v => app.set_dof_focal_range(v));
                dofFolder.add(settings, 'dofAperture', 0.5, 22).name('Aperture (f-stop)').onChange(v => app.set_dof_aperture(v));
                dofFolder.add(settings, 'dofBlurStrength', 0, 3).name('Blur Strength').onChange(v => app.set_dof_blur_strength(v));
                dofFolder.add(settings, 'dofHighlightBoost', 0, 2).name('Highlight Boost').onChange(v => { if (app.set_dof_highlight_boost) app.set_dof_highlight_boost(v); });
                dofFolder.add(settings, 'dofHighlightThreshold', 0, 1).name('Highlight Threshold').onChange(v => { if (app.set_dof_highlight_threshold) app.set_dof_highlight_threshold(v); });

                // SSR
                const ssrFolder = gui.addFolder('SSR (Reflections)');
                ssrFolder.add(settings, 'ssrEnabled').name('Enable').onChange(v => app.set_ssr_enabled(v));
                ssrFolder.add(settings, 'ssrQuality', { Low: 0, Medium: 1, High: 2, Ultra: 3 }).name('Quality').onChange(v => app.set_ssr_quality(parseInt(v)));
                ssrFolder.add(settings, 'ssrMaxDistance', 5, 50).name('Max Distance').onChange(v => app.set_ssr_max_distance(v));
                ssrFolder.add(settings, 'ssrThickness', 0.01, 1).name('Thickness').onChange(v => app.set_ssr_thickness(v));
                ssrFolder.add(settings, 'ssrIntensity', 0, 1).name('Intensity').onChange(v => app.set_ssr_intensity(v));

                // Motion Blur
                const mbFolder = gui.addFolder('Motion Blur');
                mbFolder.add(settings, 'motionBlurEnabled').name('Enable').onChange(v => app.set_motion_blur_enabled(v));
                mbFolder.add(settings, 'motionBlurQuality', { Low: 0, Medium: 1, High: 2 }).name('Quality').onChange(v => app.set_motion_blur_quality(parseInt(v)));
                mbFolder.add(settings, 'motionBlurIntensity', 0, 2).name('Intensity').onChange(v => app.set_motion_blur_intensity(v));
                mbFolder.add(settings, 'motionBlurMax', 4, 64).name('Max Blur').onChange(v => app.set_motion_blur_max(v));
                mbFolder.add(settings, 'motionBlurVelocity', 0.1, 3).name('Velocity Scale').onChange(v => app.set_motion_blur_velocity_scale(v));

                // Outline
                const outlineFolder = gui.addFolder('Outline');
                outlineFolder.add(settings, 'outlineEnabled').name('Enable').onChange(v => app.set_outline_enabled(v));
                outlineFolder.add(settings, 'outlineMode', { Depth: 0, Normal: 1, Combined: 2 }).name('Mode').onChange(v => app.set_outline_mode(parseInt(v)));
                outlineFolder.add(settings, 'outlineThickness', 0.5, 5).name('Thickness').onChange(v => app.set_outline_thickness(v));
                outlineFolder.add(settings, 'outlineDepthThreshold', 0.01, 0.5).name('Depth Threshold').onChange(v => app.set_outline_depth_threshold(v));
                outlineFolder.add(settings, 'outlineNormalThreshold', 0, 1).name('Normal Threshold').onChange(v => app.set_outline_normal_threshold(v));
                outlineFolder.addColor(settings, 'outlineColor').name('Color').onChange(v => {
                    const rgb = hexToRgb(v);
                    app.set_outline_color(rgb.r, rgb.g, rgb.b);
                });

                // Anti-Aliasing
                const aaFolder = gui.addFolder('Anti-Aliasing');
                aaFolder.add(settings, 'aaMode', { None: 0, FXAA: 1, SMAA: 2, TAA: 3 }).name('Mode').onChange(v => app.set_aa_mode(parseInt(v)));
                aaFolder.add(settings, 'fxaaQuality', { Low: 0, Medium: 1, High: 2 }).name('FXAA Quality').onChange(v => app.set_fxaa_quality(parseInt(v)));
                aaFolder.add(settings, 'smaaQuality', { Low: 0, Medium: 1, High: 2, Ultra: 3 }).name('SMAA Quality').onChange(v => app.set_smaa_quality(parseInt(v)));
                aaFolder.add(settings, 'taaBlend', 0.5, 0.98).name('TAA Blend').onChange(v => app.set_taa_blend_factor(v));
                aaFolder.add(settings, 'taaSharpness', 0, 1).name('TAA Sharpness').onChange(v => app.set_taa_sharpness(v));

                // SSAO
                const ssaoFolder = gui.addFolder('SSAO');
                ssaoFolder.add(settings, 'ssaoEnabled').name('Enable').onChange(v => app.set_ssao_enabled(v));
                ssaoFolder.add(settings, 'ssaoQuality', { Low: 0, Medium: 1, High: 2, Ultra: 3 }).name('Quality').onChange(v => app.set_ssao_quality(parseInt(v)));
                ssaoFolder.add(settings, 'ssaoRadius', 0.1, 2).name('Radius').onChange(v => app.set_ssao_radius(v));
                ssaoFolder.add(settings, 'ssaoIntensity', 0, 3).name('Intensity').onChange(v => app.set_ssao_intensity(v));
                ssaoFolder.add(settings, 'ssaoBias', 0, 0.1).name('Bias').onChange(v => { if (app.set_ssao_bias) app.set_ssao_bias(v); });

                // GTAO
                const gtaoFolder = gui.addFolder('GTAO');
                gtaoFolder.add(settings, 'gtaoEnabled').name('Enable').onChange(v => {
                    if (app.set_gtao_enabled) {
                        app.set_gtao_enabled(v);
                        if (v) settings.ssaoEnabled = false;
                        gui.updateDisplay();
                    }
                });
                gtaoFolder.add(settings, 'gtaoQuality', { Low: 0, Medium: 1, High: 2, Ultra: 3 }).name('Quality').onChange(v => { if (app.set_gtao_quality) app.set_gtao_quality(parseInt(v)); });
                gtaoFolder.add(settings, 'gtaoRadius', 0.1, 2).name('Radius').onChange(v => { if (app.set_gtao_radius) app.set_gtao_radius(v); });
                gtaoFolder.add(settings, 'gtaoIntensity', 0.5, 3).name('Intensity').onChange(v => { if (app.set_gtao_intensity) app.set_gtao_intensity(v); });
                gtaoFolder.add(settings, 'gtaoPower', 0.5, 4).name('Power').onChange(v => { if (app.set_gtao_power) app.set_gtao_power(v); });
                gtaoFolder.add(settings, 'gtaoFalloff', 0, 1).name('Falloff').onChange(v => { if (app.set_gtao_falloff) app.set_gtao_falloff(v); });

                // Lumen GI
                const lumenFolder = gui.addFolder('Lumen GI');
                lumenFolder.add(settings, 'lumenEnabled').name('Enable').onChange(v => { if (app.set_lumen_enabled) app.set_lumen_enabled(v); });
                lumenFolder.add(settings, 'lumenQuality', { Low: 0, Medium: 1, High: 2, Ultra: 3 }).name('Quality').onChange(v => { if (app.set_lumen_quality) app.set_lumen_quality(parseInt(v)); });
                lumenFolder.add(settings, 'lumenIntensity', 0, 3).name('Intensity').onChange(v => { if (app.set_lumen_intensity) app.set_lumen_intensity(v); });
                lumenFolder.add(settings, 'lumenDistance', 1, 20).name('Max Distance').onChange(v => { if (app.set_lumen_max_distance) app.set_lumen_max_distance(v); });
                lumenFolder.add(settings, 'lumenThickness', 0.01, 0.5).name('Thickness').onChange(v => { if (app.set_lumen_thickness) app.set_lumen_thickness(v); });

                // Volumetric Fog
                const fogFolder = gui.addFolder('Volumetric Fog');
                fogFolder.add(settings, 'fogEnabled').name('Enable').onChange(v => { if (app.set_volumetric_fog_enabled) app.set_volumetric_fog_enabled(v); });
                fogFolder.add(settings, 'fogQuality', { Low: 0, Medium: 1, High: 2, Ultra: 3 }).name('Quality').onChange(v => { if (app.set_volumetric_fog_quality) app.set_volumetric_fog_quality(parseInt(v)); });
                fogFolder.add(settings, 'fogDensity', 0, 1).name('Density').onChange(v => { if (app.set_volumetric_fog_density) app.set_volumetric_fog_density(v); });
                fogFolder.add(settings, 'fogDistance', 10, 500).name('Max Distance').onChange(v => { if (app.set_volumetric_fog_max_distance) app.set_volumetric_fog_max_distance(v); });
                fogFolder.add(settings, 'fogHeight', 0, 0.5).name('Height Falloff').onChange(v => { if (app.set_volumetric_fog_height_falloff) app.set_volumetric_fog_height_falloff(v); });
                fogFolder.add(settings, 'fogScattering', 0, 1).name('Scattering').onChange(v => { if (app.set_volumetric_fog_scattering) app.set_volumetric_fog_scattering(v); });
                fogFolder.add(settings, 'fogGodrays').name('God Rays').onChange(v => { if (app.set_volumetric_fog_god_rays) app.set_volumetric_fog_god_rays(v); });
                fogFolder.add(settings, 'fogGodrayIntensity', 0, 3).name('God Ray Intensity').onChange(v => { if (app.set_volumetric_fog_god_ray_intensity) app.set_volumetric_fog_god_ray_intensity(v); });

                // Particles
                const particleFolder = gui.addFolder('Particles');
                particleFolder.add(settings, 'spawnFire').name('Fire');
                particleFolder.add(settings, 'spawnSmoke').name('Smoke');
                particleFolder.add(settings, 'spawnSparks').name('Sparks');
                particleFolder.add(settings, 'spawnMagic').name('Magic');
                particleFolder.add(settings, 'spawnDebris').name('Debris');
                particleFolder.add(settings, 'clearParticles').name('Clear All');
                particleFolder.add(settings, 'particleGravity').name('Gravity');
                particleFolder.add(settings, 'particleTurbulence').name('Turbulence');

                // IBL
                const iblFolder = gui.addFolder('IBL');
                iblFolder.add(settings, 'iblDiffuse', 0, 2).name('Diffuse').onChange(v => { if (app.set_ibl_diffuse_intensity) app.set_ibl_diffuse_intensity(v); });
                iblFolder.add(settings, 'iblSpecular', 0, 2).name('Specular').onChange(v => { if (app.set_ibl_specular_intensity) app.set_ibl_specular_intensity(v); });
                iblFolder.add(settings, 'resetIBL').name('Reset');

                // Detail Mapping
                const detailFolder = gui.addFolder('Detail Mapping');
                detailFolder.add(settings, 'detailEnabled').name('Detail Normals').onChange(v => { if (app.set_detail_enabled) app.set_detail_enabled(v); });
                detailFolder.add(settings, 'detailScale', 1, 50).name('Scale').onChange(v => { if (app.set_detail_scale) app.set_detail_scale(v); });
                detailFolder.add(settings, 'detailIntensity', 0, 1).name('Intensity').onChange(v => { if (app.set_detail_intensity) app.set_detail_intensity(v); });
                detailFolder.add(settings, 'detailMaxDistance', 1, 50).name('Max Distance').onChange(v => { if (app.set_detail_max_distance) app.set_detail_max_distance(v); });
                detailFolder.add(settings, 'detailAlbedoEnabled').name('Detail Albedo').onChange(v => { if (app.set_detail_albedo_enabled) app.set_detail_albedo_enabled(v); });
                detailFolder.add(settings, 'detailAlbedoScale', 1, 50).name('Albedo Scale').onChange(v => { if (app.set_detail_albedo_scale) app.set_detail_albedo_scale(v); });
                detailFolder.add(settings, 'detailAlbedoIntensity', 0, 1).name('Albedo Intensity').onChange(v => { if (app.set_detail_albedo_intensity) app.set_detail_albedo_intensity(v); });
                detailFolder.add(settings, 'detailAlbedoBlendMode', { Overlay: 0, Multiply: 1, 'Soft Light': 2 }).name('Blend Mode').onChange(v => { if (app.set_detail_albedo_blend_mode) app.set_detail_albedo_blend_mode(parseInt(v)); });

                // Helpers
                const helpersFolder = gui.addFolder('Helpers');
                helpersFolder.add(settings, 'showGrid').name('Show Grid').onChange(v => app.set_grid_visible(v));
                helpersFolder.add(settings, 'showAxes').name('Show Axes').onChange(v => app.set_axes_visible(v));
                helpersFolder.add({ resetAll: function() {
                    if (confirm('Reset all settings to defaults?')) {
                        localStorage.removeItem(STORAGE_KEY);
                        location.reload();
                    }
                }}, 'resetAll').name('Reset All Settings');

                // Gizmo
                const gizmoFolder = gui.addFolder('Transform Gizmo');
                gizmoFolder.add(settings, 'gizmoEnabled').name('Enable').onChange(v => { if (app.set_gizmo_enabled) app.set_gizmo_enabled(v); });
                gizmoFolder.add(settings, 'gizmoMode', { Translate: 0, Rotate: 1, Scale: 2 }).name('Mode').onChange(v => { if (app.set_gizmo_mode) app.set_gizmo_mode(parseInt(v)); });

                // Close all folders by default
                renderFolder.close();
                cameraFolder.close();
                dayNightFolder.close();
                bloomFolder.close();
                tonemapFolder.close();
                autoExpFolder.close();
                vignetteFolder.close();
                ccFolder.close();
                hemiFolder.close();
                skyboxFolder.close();
                procSkyFolder.close();
                shadowFolder.close();
                materialFolder.close();
                dofFolder.close();
                ssrFolder.close();
                mbFolder.close();
                outlineFolder.close();
                aaFolder.close();
                ssaoFolder.close();
                gtaoFolder.close();
                lumenFolder.close();
                fogFolder.close();
                particleFolder.close();
                iblFolder.close();
                detailFolder.close();
                helpersFolder.close();
                gizmoFolder.close();

                // Auto-save on any change - lil-gui uses onChange event on the gui itself
                gui.onChange(() => saveSettings());

                // Helper functions
                function hexToRgb(hex) {
                    const r = parseInt(hex.slice(1, 3), 16) / 255;
                    const g = parseInt(hex.slice(3, 5), 16) / 255;
                    const b = parseInt(hex.slice(5, 7), 16) / 255;
                    return { r, g, b };
                }

                function updateSkyColors() {
                    const sky = hexToRgb(settings.skyboxSkyColor);
                    const horizon = hexToRgb(settings.skyboxHorizonColor);
                    const ground = hexToRgb(settings.skyboxGroundColor);
                    app.set_sky_colors(
                        Math.round(sky.r * 255), Math.round(sky.g * 255), Math.round(sky.b * 255),
                        Math.round(horizon.r * 255), Math.round(horizon.g * 255), Math.round(horizon.b * 255),
                        Math.round(ground.r * 255), Math.round(ground.g * 255), Math.round(ground.b * 255)
                    );
                }

                function updateProceduralSkySun() {
                    app.set_procedural_sky_sun_position(settings.proceduralSkyAzimuth, settings.proceduralSkyElevation);
                }

                function updateSunFromTime(time) {
                    const angle = time * Math.PI * 2 - Math.PI / 2;
                    const sunHeight = Math.sin(angle);
                    const sunHorizontal = Math.cos(angle);

                    const dirX = -sunHorizontal * 0.3;
                    const dirY = -sunHeight;
                    const dirZ = -0.5;
                    const len = Math.sqrt(dirX * dirX + dirY * dirY + dirZ * dirZ);
                    app.set_shadow_light_direction(dirX / len, dirY / len, dirZ / len);

                    const azimuth = (time * 360 + 90) % 360;
                    const elevation = Math.asin(Math.max(-1, Math.min(1, sunHeight))) * (180 / Math.PI);
                    app.set_procedural_sky_sun_position(azimuth, elevation);

                    settings.proceduralSkyAzimuth = azimuth;
                    settings.proceduralSkyElevation = Math.max(-10, elevation);

                    if (sunHeight < -0.1) {
                        app.set_procedural_sky_sun_intensity(0.5);
                        app.set_procedural_sky_exposure(0.3);
                        app.set_directional_light_intensity(0.05);
                    } else if (sunHeight < 0.3) {
                        const t = (sunHeight + 0.1) / 0.4;
                        app.set_procedural_sky_sun_intensity(8 + t * 14);
                        app.set_procedural_sky_exposure(0.5 + t * 0.7);
                        app.set_directional_light_intensity(0.2 + t * 0.8);
                    } else {
                        app.set_procedural_sky_sun_intensity(22);
                        app.set_procedural_sky_exposure(1.2);
                        app.set_directional_light_intensity(1.0);
                    }
                }

                function createParticleEffect(type) {
                    if (!app.create_particle_system) return;
                    const id = app.create_particle_system(type);
                    app.set_particle_position(id, 0, 0.5, 0);
                    if (settings.particleGravity) app.add_particle_gravity(id, 3.0);
                    if (settings.particleTurbulence) app.add_particle_turbulence(id, 1.5, 1.0);
                }

                // State
                let lastTime = performance.now();
                let frameCount = 0;
                let fps = 0;
                const keysPressed = {};
                let isFreelooking = false;
                let isGliding = false;
                let isPanning = false;
                let isGizmoDragging = false;
                let lastMouseX = 0;
                let lastMouseY = 0;
                let lastFrameTime = performance.now();

                // Animation loop
                function frame() {
                    const currentTime = performance.now();
                    const deltaTime = (currentTime - lastFrameTime) / 1000;
                    lastFrameTime = currentTime;

                    // Day/night cycle
                    if (settings.dayNightEnabled) {
                        settings.dayNightTime += deltaTime * settings.dayNightSpeed * 0.01;
                        if (settings.dayNightTime > 1) settings.dayNightTime -= 1;
                        updateSunFromTime(settings.dayNightTime);
                    }

                    // Keyboard movement
                    if (isFreelooking) {
                        let forward = 0, right = 0, up = 0;
                        if (keysPressed['KeyW']) forward += 1;
                        if (keysPressed['KeyS']) forward -= 1;
                        if (keysPressed['KeyA']) right -= 1;
                        if (keysPressed['KeyD']) right += 1;
                        if (keysPressed['KeyE']) up += 1;
                        if (keysPressed['KeyQ']) up -= 1;
                        if (forward !== 0 || right !== 0 || up !== 0) {
                            const speedMultiplier = keysPressed['ShiftLeft'] || keysPressed['ShiftRight'] ? 3.0 : 1.0;
                            app.on_keyboard_move(forward * speedMultiplier, right * speedMultiplier, up * speedMultiplier);
                        }
                    }

                    app.frame();
                    frameCount++;

                    const now = performance.now();
                    if (now - lastTime >= 1000) {
                        fps = frameCount;
                        frameCount = 0;
                        lastTime = now;

                        const stats = app.stats();
                        const naniteClusters = app.nanite_cluster_count();
                        statsEl.innerHTML = `
                            FPS: ${fps}<br>
                            Draw Calls: ${stats.draw_calls}<br>
                            Triangles: ${stats.triangles}<br>
                            Nanite Clusters: ${naniteClusters}<br>
                            Frame: ${stats.frame}
                        `;
                    }

                    requestAnimationFrame(frame);
                }
                requestAnimationFrame(frame);

                // Resize
                window.addEventListener('resize', () => app.resize(window.innerWidth, window.innerHeight));

                // Mouse controls
                canvas.addEventListener('mousedown', (e) => {
                    if (e.button === 0 && !e.altKey && app.is_gizmo_enabled && app.is_gizmo_enabled()) {
                        if (app.on_gizmo_drag_start && app.on_gizmo_drag_start(e.clientX, e.clientY)) {
                            isGizmoDragging = true;
                            e.preventDefault();
                            return;
                        }
                    }

                    if (e.button === 0) isGliding = true;
                    else if (e.button === 1) isPanning = true;
                    else if (e.button === 2) isFreelooking = true;
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;
                    e.preventDefault();
                });

                window.addEventListener('mouseup', (e) => {
                    if (isGizmoDragging) {
                        if (app.on_gizmo_drag_end) app.on_gizmo_drag_end();
                        isGizmoDragging = false;
                    }
                    if (e.button === 0) isGliding = false;
                    else if (e.button === 1) isPanning = false;
                    else if (e.button === 2) isFreelooking = false;
                });

                window.addEventListener('mousemove', (e) => {
                    const deltaX = e.clientX - lastMouseX;
                    const deltaY = e.clientY - lastMouseY;
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;

                    if (isGizmoDragging) {
                        if (app.on_gizmo_drag) app.on_gizmo_drag(e.clientX, e.clientY);
                    } else if (isFreelooking) {
                        if (app.on_mouse_freelook) app.on_mouse_freelook(deltaX, deltaY);
                    } else if (isGliding) {
                        if (app.on_mouse_glide) app.on_mouse_glide(deltaX, deltaY);
                    } else if (isPanning) {
                        app.on_mouse_pan(deltaX, deltaY);
                    } else if (app.is_gizmo_enabled && app.is_gizmo_enabled()) {
                        if (app.on_gizmo_hover) app.on_gizmo_hover(e.clientX, e.clientY);
                    }
                });

                canvas.addEventListener('wheel', (e) => {
                    app.on_mouse_wheel(e.deltaY);
                    e.preventDefault();
                }, { passive: false });

                canvas.addEventListener('contextmenu', (e) => e.preventDefault());

                // Keyboard
                window.addEventListener('keydown', (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                    keysPressed[e.code] = true;

                    if (!isFreelooking && app.is_gizmo_enabled && app.is_gizmo_enabled()) {
                        if (e.code === 'Digit1') { if (app.set_gizmo_mode) app.set_gizmo_mode(0); settings.gizmoMode = 0; }
                        else if (e.code === 'Digit2') { if (app.set_gizmo_mode) app.set_gizmo_mode(1); settings.gizmoMode = 1; }
                        else if (e.code === 'Digit3') { if (app.set_gizmo_mode) app.set_gizmo_mode(2); settings.gizmoMode = 2; }
                        gui.updateDisplay();
                    }

                    if (e.code === 'KeyF' && !isFreelooking) {
                        if (app.focus_on_origin) app.focus_on_origin();
                    }
                });
                window.addEventListener('keyup', (e) => keysPressed[e.code] = false);

                // Model loading
                document.getElementById('model-input').addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    try {
                        const ext = file.name.split('.').pop().toLowerCase();
                        if (ext === 'glb' || ext === 'gltf') {
                            const data = new Uint8Array(await file.arrayBuffer());
                            app.load_gltf(data);
                        } else if (ext === 'obj') {
                            app.load_obj(await file.text());
                        }
                    } catch (err) {
                        console.error('Failed to load model:', err);
                        alert('Failed to load model: ' + err);
                    }
                    e.target.value = '';
                });

                document.getElementById('nanite-input').addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    try {
                        const ext = file.name.split('.').pop().toLowerCase();
                        if (ext === 'glb' || ext === 'gltf') {
                            const data = new Uint8Array(await file.arrayBuffer());
                            app.load_gltf_nanite(data);
                        }
                    } catch (err) {
                        console.error('Failed to load Nanite model:', err);
                    }
                    e.target.value = '';
                });

                document.getElementById('clear-btn').addEventListener('click', () => {
                    app.clear_loaded_meshes();
                    if (app.detach_gizmo) app.detach_gizmo();
                });

                document.getElementById('demo-btn').addEventListener('click', () => app.add_demo_shapes());
                document.getElementById('nanite-demo-btn').addEventListener('click', () => app.add_nanite_demo_cube());

                // Initialize
                app.add_demo_shapes();
                // Create terrain grid: 5x5 tiles, 100 units each, mountains on outer ring
                app.add_terrain_grid(
                    5,      // grid_size: 5x5 grid
                    100,    // tile_size: each tile is 100 units
                    0,      // y: base height at 0
                    60,     // mountain_height: rolling hills up to 60 units
                    32      // resolution: 32x32 vertices per mountain tile
                );

                // Apply all saved settings to the app
                function applyAllSettings() {
                    // Render
                    app.set_render_mode(settings.renderMode);
                    // Camera
                    app.set_camera_fov(settings.cameraFov);
                    app.set_camera_near(settings.cameraNear);
                    app.set_camera_far(settings.cameraFar);
                    app.set_camera_move_speed(settings.cameraMoveSpeed);
                    app.set_camera_rotate_sensitivity(settings.cameraRotateSensitivity);
                    app.set_camera_zoom_speed(settings.cameraZoomSpeed);
                    // Bloom
                    app.set_bloom_enabled(settings.bloomEnabled);
                    app.set_bloom_intensity(settings.bloomIntensity);
                    app.set_bloom_threshold(settings.bloomThreshold);
                    // Tonemapping
                    app.set_tonemapping_mode(settings.tonemapMode);
                    app.set_exposure(settings.exposure);
                    // Auto Exposure
                    app.set_auto_exposure_enabled(settings.autoExposureEnabled);
                    app.set_auto_exposure_compensation(settings.autoExposureCompensation);
                    app.set_auto_exposure_speed_up(settings.autoExposureSpeedUp);
                    app.set_auto_exposure_speed_down(settings.autoExposureSpeedDown);
                    // Vignette
                    app.set_vignette_enabled(settings.vignetteEnabled);
                    app.set_vignette_intensity(settings.vignetteIntensity);
                    app.set_vignette_smoothness(settings.vignetteSmoothness);
                    app.set_vignette_roundness(settings.vignetteRoundness);
                    // Color Correction
                    app.set_color_correction_enabled(settings.ccEnabled);
                    app.set_cc_brightness(settings.ccBrightness);
                    app.set_cc_contrast(settings.ccContrast);
                    app.set_cc_saturation(settings.ccSaturation);
                    app.set_cc_gamma(settings.ccGamma);
                    app.set_cc_temperature(settings.ccTemperature);
                    app.set_cc_tint(settings.ccTint);
                    // Hemisphere
                    app.set_hemisphere_light_enabled(settings.hemisphereEnabled);
                    const hemiSky = hexToRgb(settings.hemisphereSkyColor);
                    app.set_hemisphere_sky_color(hemiSky.r, hemiSky.g, hemiSky.b);
                    const hemiGround = hexToRgb(settings.hemisphereGroundColor);
                    app.set_hemisphere_ground_color(hemiGround.r, hemiGround.g, hemiGround.b);
                    app.set_hemisphere_intensity(settings.hemisphereIntensity);
                    // Skybox
                    app.set_skybox_enabled(settings.skyboxEnabled);
                    app.set_skybox_exposure(settings.skyboxExposure);
                    updateSkyColors();
                    // Procedural Sky
                    app.set_procedural_sky_enabled(settings.proceduralSkyEnabled);
                    app.set_procedural_sky_sun_intensity(settings.proceduralSkySunIntensity);
                    app.set_procedural_sky_turbidity(settings.proceduralSkyTurbidity);
                    app.set_procedural_sky_rayleigh(settings.proceduralSkyRayleigh);
                    app.set_procedural_sky_mie(settings.proceduralSkyMie);
                    app.set_procedural_sky_mie_directional(settings.proceduralSkyMieG);
                    app.set_procedural_sky_exposure(settings.proceduralSkyExposure);
                    app.set_procedural_sky_cloud_speed(settings.proceduralSkyCloudSpeed);
                    // Shadows
                    if (app.set_shadows_enabled) app.set_shadows_enabled(settings.shadowsEnabled);
                    if (app.set_shadow_resolution) app.set_shadow_resolution(settings.shadowResolution);
                    if (app.set_shadow_pcf_mode) app.set_shadow_pcf_mode(settings.shadowPcfMode);
                    if (app.set_shadow_bias) app.set_shadow_bias(settings.shadowBias);
                    if (app.set_shadow_normal_bias) app.set_shadow_normal_bias(settings.shadowNormalBias);
                    if (app.set_pcss_light_size) app.set_pcss_light_size(settings.pcssLightSize);
                    if (app.set_pcss_max_filter_radius) app.set_pcss_max_filter_radius(settings.pcssMaxRadius);
                    if (app.set_contact_shadows_enabled) app.set_contact_shadows_enabled(settings.contactShadowsEnabled);
                    if (app.set_contact_shadow_distance) app.set_contact_shadow_distance(settings.contactShadowDistance);
                    if (app.set_contact_shadow_thickness) app.set_contact_shadow_thickness(settings.contactShadowThickness);
                    if (app.set_contact_shadow_intensity) app.set_contact_shadow_intensity(settings.contactShadowIntensity);
                    if (app.set_shadow_cascades) app.set_shadow_cascades(settings.shadowCascades);
                    // Material
                    if (app.set_clear_coat) app.set_clear_coat(settings.clearCoat);
                    if (app.set_clear_coat_roughness) app.set_clear_coat_roughness(settings.clearCoatRoughness);
                    if (app.set_sheen) app.set_sheen(settings.sheen);
                    const sheenRgb = hexToRgb(settings.sheenColor);
                    if (app.set_sheen_color) app.set_sheen_color(sheenRgb.r, sheenRgb.g, sheenRgb.b);
                    if (app.set_material_metallic) app.set_material_metallic(settings.baseMetallic);
                    if (app.set_material_roughness) app.set_material_roughness(settings.baseRoughness);
                    // DoF
                    app.set_dof_enabled(settings.dofEnabled);
                    app.set_dof_quality(settings.dofQuality);
                    app.set_dof_focal_distance(settings.dofFocalDistance);
                    app.set_dof_focal_range(settings.dofFocalRange);
                    app.set_dof_aperture(settings.dofAperture);
                    app.set_dof_blur_strength(settings.dofBlurStrength);
                    if (app.set_dof_highlight_boost) app.set_dof_highlight_boost(settings.dofHighlightBoost);
                    if (app.set_dof_highlight_threshold) app.set_dof_highlight_threshold(settings.dofHighlightThreshold);
                    // SSR
                    app.set_ssr_enabled(settings.ssrEnabled);
                    app.set_ssr_quality(settings.ssrQuality);
                    app.set_ssr_max_distance(settings.ssrMaxDistance);
                    app.set_ssr_thickness(settings.ssrThickness);
                    app.set_ssr_intensity(settings.ssrIntensity);
                    // Motion Blur
                    app.set_motion_blur_enabled(settings.motionBlurEnabled);
                    app.set_motion_blur_quality(settings.motionBlurQuality);
                    app.set_motion_blur_intensity(settings.motionBlurIntensity);
                    app.set_motion_blur_max(settings.motionBlurMax);
                    app.set_motion_blur_velocity_scale(settings.motionBlurVelocity);
                    // Outline
                    app.set_outline_enabled(settings.outlineEnabled);
                    app.set_outline_mode(settings.outlineMode);
                    app.set_outline_thickness(settings.outlineThickness);
                    app.set_outline_depth_threshold(settings.outlineDepthThreshold);
                    app.set_outline_normal_threshold(settings.outlineNormalThreshold);
                    const outlineRgb = hexToRgb(settings.outlineColor);
                    app.set_outline_color(outlineRgb.r, outlineRgb.g, outlineRgb.b);
                    // AA
                    app.set_aa_mode(settings.aaMode);
                    app.set_fxaa_quality(settings.fxaaQuality);
                    app.set_smaa_quality(settings.smaaQuality);
                    app.set_taa_blend_factor(settings.taaBlend);
                    app.set_taa_sharpness(settings.taaSharpness);
                    // SSAO
                    app.set_ssao_enabled(settings.ssaoEnabled);
                    app.set_ssao_quality(settings.ssaoQuality);
                    app.set_ssao_radius(settings.ssaoRadius);
                    app.set_ssao_intensity(settings.ssaoIntensity);
                    if (app.set_ssao_bias) app.set_ssao_bias(settings.ssaoBias);
                    // GTAO
                    if (app.set_gtao_enabled) app.set_gtao_enabled(settings.gtaoEnabled);
                    if (app.set_gtao_quality) app.set_gtao_quality(settings.gtaoQuality);
                    if (app.set_gtao_radius) app.set_gtao_radius(settings.gtaoRadius);
                    if (app.set_gtao_intensity) app.set_gtao_intensity(settings.gtaoIntensity);
                    if (app.set_gtao_power) app.set_gtao_power(settings.gtaoPower);
                    if (app.set_gtao_falloff) app.set_gtao_falloff(settings.gtaoFalloff);
                    // Lumen GI
                    if (app.set_lumen_enabled) app.set_lumen_enabled(settings.lumenEnabled);
                    if (app.set_lumen_quality) app.set_lumen_quality(settings.lumenQuality);
                    if (app.set_lumen_intensity) app.set_lumen_intensity(settings.lumenIntensity);
                    if (app.set_lumen_max_distance) app.set_lumen_max_distance(settings.lumenDistance);
                    if (app.set_lumen_thickness) app.set_lumen_thickness(settings.lumenThickness);
                    // Fog
                    if (app.set_volumetric_fog_enabled) app.set_volumetric_fog_enabled(settings.fogEnabled);
                    if (app.set_volumetric_fog_quality) app.set_volumetric_fog_quality(settings.fogQuality);
                    if (app.set_volumetric_fog_density) app.set_volumetric_fog_density(settings.fogDensity);
                    if (app.set_volumetric_fog_max_distance) app.set_volumetric_fog_max_distance(settings.fogDistance);
                    if (app.set_volumetric_fog_height_falloff) app.set_volumetric_fog_height_falloff(settings.fogHeight);
                    if (app.set_volumetric_fog_scattering) app.set_volumetric_fog_scattering(settings.fogScattering);
                    if (app.set_volumetric_fog_god_rays) app.set_volumetric_fog_god_rays(settings.fogGodrays);
                    if (app.set_volumetric_fog_god_ray_intensity) app.set_volumetric_fog_god_ray_intensity(settings.fogGodrayIntensity);
                    // IBL
                    if (app.set_ibl_diffuse_intensity) app.set_ibl_diffuse_intensity(settings.iblDiffuse);
                    if (app.set_ibl_specular_intensity) app.set_ibl_specular_intensity(settings.iblSpecular);
                    // Detail
                    if (app.set_detail_enabled) app.set_detail_enabled(settings.detailEnabled);
                    if (app.set_detail_scale) app.set_detail_scale(settings.detailScale);
                    if (app.set_detail_intensity) app.set_detail_intensity(settings.detailIntensity);
                    if (app.set_detail_max_distance) app.set_detail_max_distance(settings.detailMaxDistance);
                    if (app.set_detail_albedo_enabled) app.set_detail_albedo_enabled(settings.detailAlbedoEnabled);
                    if (app.set_detail_albedo_scale) app.set_detail_albedo_scale(settings.detailAlbedoScale);
                    if (app.set_detail_albedo_intensity) app.set_detail_albedo_intensity(settings.detailAlbedoIntensity);
                    if (app.set_detail_albedo_blend_mode) app.set_detail_albedo_blend_mode(settings.detailAlbedoBlendMode);
                    // Helpers
                    app.set_grid_visible(settings.showGrid);
                    app.set_axes_visible(settings.showAxes);
                }
                applyAllSettings();
                console.log('Settings loaded from localStorage');

            } catch (err) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = err.message || String(err);
                console.error('Ren Engine initialization failed:', err);
            }
        }

        init();
    </script>
</body>
</html>
